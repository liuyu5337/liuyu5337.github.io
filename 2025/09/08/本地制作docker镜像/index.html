

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="zhq">
  <meta name="keywords" content="">
  
    <meta name="description" content="国内使用 docker ，如果不使用梯子，存在拉取docker镜像失败的情况。为了使用docker，需要自己构建镜像。 遇到的问题 在拉取镜像的时候，如果不用梯子，经常遇到的错误是： 1Get https:&#x2F;&#x2F;registry-1.docker.io&#x2F;v2&#x2F;: net&#x2F;http: request canceled while waiting for connection (Client.Timeo">
<meta property="og:type" content="article">
<meta property="og:title" content="本地制作docker镜像">
<meta property="og:url" content="http://liuyu5337.github.io/2025/09/08/%E6%9C%AC%E5%9C%B0%E5%88%B6%E4%BD%9Cdocker%E9%95%9C%E5%83%8F/index.html">
<meta property="og:site_name" content="零壹网络">
<meta property="og:description" content="国内使用 docker ，如果不使用梯子，存在拉取docker镜像失败的情况。为了使用docker，需要自己构建镜像。 遇到的问题 在拉取镜像的时候，如果不用梯子，经常遇到的错误是： 1Get https:&#x2F;&#x2F;registry-1.docker.io&#x2F;v2&#x2F;: net&#x2F;http: request canceled while waiting for connection (Client.Timeo">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-09-08T15:03:50.000Z">
<meta property="article:modified_time" content="2025-09-08T16:27:00.322Z">
<meta property="article:author" content="zhq">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>本地制作docker镜像 - 零壹网络</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"liuyu5337.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>零壹网络</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="本地制作docker镜像"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-09-08 23:03" pubdate>
          2025年9月8日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          12k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          103 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">本地制作docker镜像</h1>
            
            
              <div class="markdown-body">
                
                <p>国内使用 docker
，如果不使用梯子，存在拉取docker镜像失败的情况。为了使用docker，需要自己构建镜像。</p>
<h4 id="遇到的问题">遇到的问题</h4>
<p>在拉取镜像的时候，如果不用梯子，经常遇到的错误是：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">Get https://registry-1.docker.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)<br></code></pre></td></tr></table></figure>
<p>这个时候，通常是<strong>使用国内镜像加速</strong>,
可以用镜像加速器：</p>
<ul>
<li><p>编辑配置文件
<code>/etc/docker/daemon.json</code>（如果没有就新建）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;registry-mirrors&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;https://registry.docker-cn.com&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;https://mirror.ccs.tencentyun.com&quot;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure>
<p>但是，通常情况下，这类方法都是无效的。</p></li>
</ul>
<h4 id="代理的方式">代理的方式</h4>
<p>如果你需要翻墙：</p>
<ul>
<li><p>确认环境变量中 <code>http_proxy</code> / <code>https_proxy</code>
配置正确；</p></li>
<li><p>或者在
<code>/etc/systemd/system/docker.service.d/http-proxy.conf</code>
添加：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Service]<br>Environment=&quot;HTTP_PROXY=http://127.0.0.1:7890/&quot;<br>Environment=&quot;HTTPS_PROXY=http://127.0.0.1:7890/&quot;<br>Environment=&quot;NO_PROXY=localhost,127.0.0.1&quot;<br></code></pre></td></tr></table></figure></li>
</ul>
<p>然后执行</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs maxima">sudo systemctl daemon-reload<br>sudo systemctl <span class="hljs-built_in">restart</span> docker<br><br>或者<br>sudo service docker <span class="hljs-built_in">restart</span><br></code></pre></td></tr></table></figure>
<p>如果，你可以科学上网，那么使用上面的方法，就可以了。如果你的环境不允许你使用梯子，就请往下看。</p>
<p>下面通过脚本排查问题开始，一步一步实现自定义创建镜像。</p>
<h5 id="排查脚本">1 排查脚本</h5>
<p><strong>一键排查脚本</strong>，可以检测 DNS、Docker Hub
访问、加速器配置、代理环境变量，帮助你定位到底卡在哪一步。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>echo &quot;====== Docker 网络排查脚本 ======&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">1. 检查 DNS 解析</span><br>echo -e &quot;\n[1] 检查 DNS 解析 registry-1.docker.io ...&quot;<br>nslookup registry-1.docker.io 2&gt;/dev/null || dig registry-1.docker.io<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">2. 检查能否访问 Docker Hub</span><br>echo -e &quot;\n[2] 测试 curl 访问 Docker Hub ...&quot;<br>curl -I --max-time 10 https://registry-1.docker.io/v2/ || echo &quot;❌ 无法访问 Docker Hub&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">3. 检查 Docker Daemon 配置</span><br>echo -e &quot;\n[3] 检查 Docker 配置文件 /etc/docker/daemon.json ...&quot;<br>if [ -f /etc/docker/daemon.json ]; then<br>    cat /etc/docker/daemon.json<br>else<br>    echo &quot;⚠️ 配置文件不存在&quot;<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">4. 检查代理环境变量</span><br>echo -e &quot;\n[4] 检查代理环境变量 ...&quot;<br>echo &quot;HTTP_PROXY=$HTTP_PROXY&quot;<br>echo &quot;HTTPS_PROXY=$HTTPS_PROXY&quot;<br>echo &quot;NO_PROXY=$NO_PROXY&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">5. 检查 systemd 里的 Docker 代理配置</span><br>echo -e &quot;\n[5] 检查 systemd 中 Docker 的代理配置 ...&quot;<br>systemctl show --property=Environment docker | grep -i proxy<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">6. 测试 docker pull</span><br>echo -e &quot;\n[6] 测试 docker pull hello-world ...&quot;<br>docker pull hello-world<br><br>echo -e &quot;\n====== 排查结束 ======&quot;<br><br></code></pre></td></tr></table></figure>
<p>运行方式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">chmod +x check-docker.sh<br>./check-docker.sh<br></code></pre></td></tr></table></figure>
<p>执行结果会依次告诉你：</p>
<ol type="1">
<li>DNS 是否能解析 <code>registry-1.docker.io</code></li>
<li>是否能直连访问 Docker Hub</li>
<li>Docker 是否配置了加速器</li>
<li>是否有代理环境变量</li>
<li>systemd 里是否有代理配置</li>
<li>拉取 <code>hello-world</code> 是否成功</li>
</ol>
<h5 id="自己制作镜像">2. 自己制作镜像</h5>
<p>通过上面的排查脚本，如果你不能直接访问docker hub,
而且也没有配置代理，那么就需要自己制作镜像。首先是制作操作系统镜像，这里就用ubuntu为例。</p>
<p>制作Ubuntu镜像，可以采用的方式：</p>
<p>一、基于官方 Ubuntu 镜像定制</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">FROM ubuntu:20.04<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置时区（避免交互卡住）</span><br>ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">更新软件源并安装常用工具</span><br>RUN apt-get update &amp;&amp; apt-get install -y \<br>    vim curl wget net-tools iputils-ping \<br>    &amp;&amp; rm -rf /var/lib/apt/lists/*<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置默认命令</span><br>CMD [&quot;/bin/bash&quot;]<br><br></code></pre></td></tr></table></figure>
<p>如果你无法连接docker hub, 那么这个方法就不能使用。</p>
<p>二、完全“裸做”一个 Ubuntu 根文件系统</p>
<p>如果你完全不想依赖官方 <code>ubuntu:20.04</code> 镜像，可以用
<strong>debootstrap</strong> 自己生成 rootfs：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">1.安装工具：<br>sudo apt-get install debootstrap<br>2.创建一个 Ubuntu 根文件系统：<br>sudo debootstrap --arch=amd64 focal ./ubuntu-rootfs http://archive.ubuntu.com/ubuntu/<br>3.用这个根文件系统制作镜像：<br>cd ubuntu-rootfs<br>sudo tar -C . -c . | docker import - my-ubuntu:20.04<br>4. 运行容器：<br>docker run -it my-ubuntu:20.04 /bin/bash<br></code></pre></td></tr></table></figure>
<p>这种方式是真正“自己做”的 Ubuntu 镜像，完全不依赖 Docker Hub。</p>
<p>三、从 ISO 做镜像（更硬核）</p>
<p>你可以下载 Ubuntu 的 ISO，用 chroot 提取 rootfs，然后
<code>docker import</code>。不过比 <code>debootstrap</code> 麻烦.</p>
<p>下面写一个 <strong>自动化脚本</strong>，用 <code>debootstrap</code>
来一键构建 Ubuntu 根文件系统，并导入 Docker 成为镜像。</p>
<p>保存成 <code>build-ubuntu-image.sh</code>，执行就能得到一个新的
Ubuntu 镜像。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">set</span> -e<br><br><span class="hljs-comment"># 默认参数</span><br>UBUNTU_VERSION=focal      <span class="hljs-comment"># Ubuntu 20.04 (focal)，可改为 jammy(22.04) 等</span><br>ARCH=amd64<br>MIRROR=http://archive.ubuntu.com/ubuntu/<br>ROOTFS_DIR=ubuntu-rootfs<br>IMAGE_NAME=my-ubuntu<br>TAG=20.04<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;====== 构建 Ubuntu Docker 镜像 ======&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;版本: <span class="hljs-variable">$UBUNTU_VERSION</span>  架构: <span class="hljs-variable">$ARCH</span>  镜像名: <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$TAG</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;使用镜像源: <span class="hljs-variable">$MIRROR</span>&quot;</span><br><span class="hljs-built_in">echo</span><br><br><span class="hljs-comment"># 检查 debootstrap 是否安装</span><br><span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v debootstrap &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;⚠️ 未找到 debootstrap，正在安装...&quot;</span><br>    sudo apt-get update &amp;&amp; sudo apt-get install -y debootstrap<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 创建 rootfs</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 开始构建 rootfs...&quot;</span><br>sudo <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$ROOTFS_DIR</span><br>sudo debootstrap --<span class="hljs-built_in">arch</span>=<span class="hljs-variable">$ARCH</span> <span class="hljs-variable">$UBUNTU_VERSION</span> <span class="hljs-variable">$ROOTFS_DIR</span> <span class="hljs-variable">$MIRROR</span><br><br><span class="hljs-comment"># 导入到 Docker</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 打包并导入 Docker...&quot;</span><br>sudo tar -C <span class="hljs-variable">$ROOTFS_DIR</span> -c . | docker import - <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$TAG</span><br><br><span class="hljs-comment"># 清理</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 清理临时文件...&quot;</span><br>sudo <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$ROOTFS_DIR</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✅ 镜像构建完成！&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;你现在可以运行: docker run -it <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$TAG</span> /bin/bash&quot;</span><br><br></code></pre></td></tr></table></figure>
<p>使用方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">1. chmod +x build-ubuntu-image.sh<br>2. ./build-ubuntu-image.sh<br>3. docker images<br>4. docker run -it my-ubuntu:20.04 /bin/bash<br></code></pre></td></tr></table></figure>
<p>如果你在国内，<code>archive.ubuntu.com</code>
可能很慢，可以改成清华源：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">MIRROR=https:<span class="hljs-regexp">//mi</span>rrors.tuna.tsinghua.edu.cn<span class="hljs-regexp">/ubuntu/</span><br></code></pre></td></tr></table></figure>
<p><code>UBUNTU_VERSION</code> 可以改成 <code>jammy</code>
(22.04)，<code>noble</code> (24.04)</p>
<h5 id="升级一下脚本支持-可选参数">3.升级一下脚本，支持
<strong>可选参数</strong></h5>
<ul>
<li>第 1 个参数：Ubuntu 代号（如
<code>focal</code>、<code>jammy</code>、<code>noble</code>）</li>
<li>第 2 个参数：镜像 TAG（如
<code>20.04</code>、<code>22.04</code>、<code>24.04</code>）</li>
</ul>
<p>如果不传参数，默认就是 Ubuntu 20.04（focal）。</p>
<p>脚本：<code>build-ubuntu-image.sh</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>set -e<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">==============================</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">一键构建 Ubuntu Docker 镜像</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用: ./build-ubuntu-image.sh [release] [tag]</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">例子: ./build-ubuntu-image.sh jammy 22.04</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">==============================</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">默认参数</span><br>DEFAULT_RELEASE=focal<br>DEFAULT_TAG=20.04<br>ARCH=amd64<br>MIRROR=https://mirrors.tuna.tsinghua.edu.cn/ubuntu/   # 清华源，国内快<br>ROOTFS_DIR=ubuntu-rootfs<br>IMAGE_NAME=my-ubuntu<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">读取用户参数</span><br>UBUNTU_RELEASE=$&#123;1:-$DEFAULT_RELEASE&#125;<br>TAG=$&#123;2:-$DEFAULT_TAG&#125;<br><br>echo &quot;====== 构建 Ubuntu Docker 镜像 ======&quot;<br>echo &quot;Ubuntu Release: $UBUNTU_RELEASE&quot;<br>echo &quot;Docker Tag: $TAG&quot;<br>echo &quot;架构: $ARCH&quot;<br>echo &quot;镜像源: $MIRROR&quot;<br>echo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查 debootstrap 是否安装</span><br>if ! command -v debootstrap &gt;/dev/null 2&gt;&amp;1; then<br>    echo &quot;⚠️ 未找到 debootstrap，正在安装...&quot;<br>    sudo apt-get update &amp;&amp; sudo apt-get install -y debootstrap<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建 rootfs</span><br>echo &quot;👉 开始构建 rootfs...&quot;<br>sudo rm -rf $ROOTFS_DIR<br>sudo debootstrap --arch=$ARCH $UBUNTU_RELEASE $ROOTFS_DIR $MIRROR<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">导入到 Docker</span><br>echo &quot;👉 打包并导入 Docker...&quot;<br>sudo tar -C $ROOTFS_DIR -c . | docker import - $IMAGE_NAME:$TAG<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理</span><br>echo &quot;👉 清理临时文件...&quot;<br>sudo rm -rf $ROOTFS_DIR<br><br>echo &quot;✅ 镜像构建完成！&quot;<br>echo &quot;你现在可以运行: docker run -it $IMAGE_NAME:$TAG /bin/bash&quot;<br><br></code></pre></td></tr></table></figure>
<p>使用示例</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 构建默认 Ubuntu 20.04：<br>./build-ubuntu-image.sh<br><span class="hljs-bullet">2.</span> 构建 Ubuntu 22.04：<br>./build-ubuntu-image.sh jammy 22.04<br><span class="hljs-bullet">3.</span> 构建 Ubuntu 24.04：<br>./build-ubuntu-image.sh noble 24.04<br><span class="hljs-bullet">4.</span> 查看镜像：<br>docker images<br></code></pre></td></tr></table></figure>
<p>这样安装的镜像，没有常用工具，把脚本升级成
<strong>带常用工具预装版</strong>，这样你构建的 Ubuntu
镜像启动后就能直接用
<code>vim</code>、<code>curl</code>、<code>ping</code>、<code>netstat</code>
等，不用再每次手动安装。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>set -e<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">==============================</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">一键构建 Ubuntu Docker 镜像 (预装常用工具)</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用: ./build-ubuntu-image.sh [release] [tag]</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">例子: ./build-ubuntu-image.sh jammy 22.04</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">==============================</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">默认参数</span><br>DEFAULT_RELEASE=focal<br>DEFAULT_TAG=20.04<br>ARCH=amd64<br>MIRROR=https://mirrors.tuna.tsinghua.edu.cn/ubuntu/   # 清华源，国内快<br>ROOTFS_DIR=ubuntu-rootfs<br>IMAGE_NAME=my-ubuntu<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">读取用户参数</span><br>UBUNTU_RELEASE=$&#123;1:-$DEFAULT_RELEASE&#125;<br>TAG=$&#123;2:-$DEFAULT_TAG&#125;<br><br>echo &quot;====== 构建 Ubuntu Docker 镜像 ======&quot;<br>echo &quot;Ubuntu Release: $UBUNTU_RELEASE&quot;<br>echo &quot;Docker Tag: $TAG&quot;<br>echo &quot;架构: $ARCH&quot;<br>echo &quot;镜像源: $MIRROR&quot;<br>echo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查 debootstrap 是否安装</span><br>if ! command -v debootstrap &gt;/dev/null 2&gt;&amp;1; then<br>    echo &quot;⚠️ 未找到 debootstrap，正在安装...&quot;<br>    sudo apt-get update &amp;&amp; sudo apt-get install -y debootstrap<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建 rootfs</span><br>echo &quot;👉 开始构建 rootfs...&quot;<br>sudo rm -rf $ROOTFS_DIR<br>sudo debootstrap --arch=$ARCH $UBUNTU_RELEASE $ROOTFS_DIR $MIRROR<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">打包 rootfs 并导入临时镜像</span><br>echo &quot;👉 打包 rootfs...&quot;<br>sudo tar -C $ROOTFS_DIR -c . | docker import - $&#123;IMAGE_NAME&#125;-base:$TAG<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">构建最终镜像 (预装常用工具)</span><br>echo &quot;👉 创建 Dockerfile 并安装常用工具...&quot;<br>cat &gt; Dockerfile &lt;&lt;EOF<br>FROM $&#123;IMAGE_NAME&#125;-base:$TAG<br><br>ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai<br><br>RUN apt-get update &amp;&amp; apt-get install -y \\<br>    vim curl wget net-tools iputils-ping less lsb-release ca-certificates \\<br>    &amp;&amp; rm -rf /var/lib/apt/lists/*<br><br>CMD [&quot;/bin/bash&quot;]<br>EOF<br><br>docker build -t $IMAGE_NAME:$TAG .<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理</span><br>echo &quot;👉 清理临时文件...&quot;<br>rm -rf $ROOTFS_DIR Dockerfile<br>docker rmi $&#123;IMAGE_NAME&#125;-base:$TAG &gt;/dev/null 2&gt;&amp;1 || true<br><br>echo &quot;✅ 镜像构建完成！&quot;<br>echo &quot;你现在可以运行: docker run -it $IMAGE_NAME:$TAG /bin/bash&quot;<br><br></code></pre></td></tr></table></figure>
<p>使用方法：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-number">1</span>. 构建默认 Ubuntu <span class="hljs-number">20.04</span>：<br>./build-ubuntu-image.<span class="hljs-keyword">sh</span><br><span class="hljs-number">2</span>. 构建 Ubuntu <span class="hljs-number">22.04</span>：<br>./build-ubuntu-image.<span class="hljs-keyword">sh</span> jammy <span class="hljs-number">22.04</span><br><span class="hljs-number">3</span>. 构建 Ubuntu <span class="hljs-number">24.04</span>：<br>./build-ubuntu-image.<span class="hljs-keyword">sh</span> noble <span class="hljs-number">24.04</span><br><span class="hljs-number">4</span>. 查看镜像：<br>docker images<br><span class="hljs-number">5</span>. 启动容器并测试：<br>docker run -it my-ubuntu:<span class="hljs-number">22.04</span><br><br>在容器里 可以直接用：<br><span class="hljs-keyword">vim</span><br>curl https://www.google.<span class="hljs-keyword">com</span><br>ping baidu.<span class="hljs-keyword">com</span><br>netstat -tulnp<br></code></pre></td></tr></table></figure>
<h5 id="把脚本再升级一下加上-模式参数">4. 把脚本再升级一下，加上
<strong>模式参数</strong></h5>
<ul>
<li><code>--minimal</code> ：只生成纯净的 Ubuntu 镜像</li>
<li><code>--full</code>
：在镜像中预装常用工具（<code>vim curl wget iputils-ping net-tools</code>
等）</li>
</ul>
<p>build-ubuntu-image.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">set</span> -e<br><br><span class="hljs-comment"># ==============================</span><br><span class="hljs-comment"># 一键构建 Ubuntu Docker 镜像</span><br><span class="hljs-comment"># 使用:</span><br><span class="hljs-comment">#   ./build-ubuntu-image.sh [release] [tag] [mode]</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 示例:</span><br><span class="hljs-comment">#   ./build-ubuntu-image.sh focal 20.04 --minimal</span><br><span class="hljs-comment">#   ./build-ubuntu-image.sh jammy 22.04 --full</span><br><span class="hljs-comment"># ==============================</span><br><br><span class="hljs-comment"># 默认参数</span><br>DEFAULT_RELEASE=focal<br>DEFAULT_TAG=20.04<br>DEFAULT_MODE=--full<br>ARCH=amd64<br>MIRROR=https://mirrors.tuna.tsinghua.edu.cn/ubuntu/   <span class="hljs-comment"># 清华源，国内快</span><br>ROOTFS_DIR=ubuntu-rootfs<br>IMAGE_NAME=my-ubuntu<br><br><span class="hljs-comment"># 读取用户输入</span><br>UBUNTU_RELEASE=<span class="hljs-variable">$&#123;1:-<span class="hljs-variable">$DEFAULT_RELEASE</span>&#125;</span><br>TAG=<span class="hljs-variable">$&#123;2:-<span class="hljs-variable">$DEFAULT_TAG</span>&#125;</span><br>MODE=<span class="hljs-variable">$&#123;3:-<span class="hljs-variable">$DEFAULT_MODE</span>&#125;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;====== 构建 Ubuntu Docker 镜像 ======&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Ubuntu Release: <span class="hljs-variable">$UBUNTU_RELEASE</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Docker Tag: <span class="hljs-variable">$TAG</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;架构: <span class="hljs-variable">$ARCH</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;镜像源: <span class="hljs-variable">$MIRROR</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;模式: <span class="hljs-variable">$MODE</span>&quot;</span><br><span class="hljs-built_in">echo</span><br><br><span class="hljs-comment"># 检查 debootstrap 是否安装</span><br><span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v debootstrap &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;⚠️ 未找到 debootstrap，正在安装...&quot;</span><br>    sudo apt-get update &amp;&amp; sudo apt-get install -y debootstrap<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 创建 rootfs</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 开始构建 rootfs...&quot;</span><br>sudo <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$ROOTFS_DIR</span><br>sudo debootstrap --<span class="hljs-built_in">arch</span>=<span class="hljs-variable">$ARCH</span> <span class="hljs-variable">$UBUNTU_RELEASE</span> <span class="hljs-variable">$ROOTFS_DIR</span> <span class="hljs-variable">$MIRROR</span><br><br><span class="hljs-comment"># 打包 rootfs 并导入临时镜像</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 打包 rootfs...&quot;</span><br>sudo tar -C <span class="hljs-variable">$ROOTFS_DIR</span> -c . | docker import - <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$TAG</span><br><br><span class="hljs-comment"># 根据模式决定是否安装工具</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$MODE</span>&quot;</span> = <span class="hljs-string">&quot;--full&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 构建 FULL 模式镜像，安装常用工具...&quot;</span><br>    <span class="hljs-built_in">cat</span> &gt; Dockerfile &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">FROM $&#123;IMAGE_NAME&#125;-base:$TAG</span><br><span class="hljs-string"></span><br><span class="hljs-string">ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai</span><br><span class="hljs-string"></span><br><span class="hljs-string">RUN apt-get update &amp;&amp; apt-get install -y \\</span><br><span class="hljs-string">    vim curl wget net-tools iputils-ping less lsb-release ca-certificates \\</span><br><span class="hljs-string">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="hljs-string"></span><br><span class="hljs-string">CMD [&quot;/bin/bash&quot;]</span><br><span class="hljs-string">EOF</span><br><br>    docker build -t <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$TAG</span> .<br>    <span class="hljs-built_in">rm</span> -f Dockerfile<br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 构建 MINIMAL 模式镜像...&quot;</span><br>    docker tag <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$TAG</span> <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$TAG</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 清理</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 清理临时文件...&quot;</span><br><span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$ROOTFS_DIR</span><br>docker rmi <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$TAG</span> &gt;/dev/null 2&gt;&amp;1 || <span class="hljs-literal">true</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✅ 镜像构建完成！&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;你现在可以运行: docker run -it <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$TAG</span> /bin/bash&quot;</span><br><br></code></pre></td></tr></table></figure>
<p>使用方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">1. 构建 Ubuntu 20.04 纯净版：<br>./build-ubuntu-image.sh focal 20.04 --minimal<br><br>2. 构建 Ubuntu 22.04 工具增强版：<br>./build-ubuntu-image.sh jammy 22.04 --full<br><br>3. 构建 Ubuntu 24.04（默认 FULL 模式）：<br>./build-ubuntu-image.sh noble 24.04<br><br>4. 查看镜像：<br>docker images<br>5. 启动容器并测试：<br>docker run -it my-ubuntu:22.04 /bin/bash<br><br></code></pre></td></tr></table></figure>
<h5 id="再升级脚本增加-自定义镜像名参数">4.1 再升级脚本，增加
<strong>自定义镜像名参数</strong>。</h5>
<p>现在脚本支持四个参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">./build-ubuntu-image.sh [release] [tag] [mode] [imagename]<br><br></code></pre></td></tr></table></figure>
<p><code>release</code> ：Ubuntu 代号（默认 <code>focal</code>）</p>
<p><code>tag</code> ：镜像 tag（默认 <code>20.04</code>）</p>
<p><code>mode</code> ：<code>--minimal</code> 或
<code>--full</code>（默认 <code>--full</code>）</p>
<p><code>imagename</code> ：自定义镜像名（默认
<code>my-ubuntu</code>）</p>
<p>build-ubuntu-image.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">set</span> -e<br><br><span class="hljs-comment"># ==============================</span><br><span class="hljs-comment"># 一键构建 Ubuntu Docker 镜像</span><br><span class="hljs-comment"># 使用:</span><br><span class="hljs-comment">#   ./build-ubuntu-image.sh [release] [tag] [mode] [imagename]</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 示例:</span><br><span class="hljs-comment">#   ./build-ubuntu-image.sh focal 20.04 --minimal</span><br><span class="hljs-comment">#   ./build-ubuntu-image.sh jammy 22.04 --full my-ubuntu-dev</span><br><span class="hljs-comment"># ==============================</span><br><br><span class="hljs-comment"># 默认参数</span><br>DEFAULT_RELEASE=focal<br>DEFAULT_TAG=20.04<br>DEFAULT_MODE=--full<br>DEFAULT_IMAGE=my-ubuntu<br>ARCH=amd64<br>MIRROR=https://mirrors.tuna.tsinghua.edu.cn/ubuntu/   <span class="hljs-comment"># 清华源，国内快</span><br>ROOTFS_DIR=ubuntu-rootfs<br><br><span class="hljs-comment"># 读取用户输入</span><br>UBUNTU_RELEASE=<span class="hljs-variable">$&#123;1:-<span class="hljs-variable">$DEFAULT_RELEASE</span>&#125;</span><br>TAG=<span class="hljs-variable">$&#123;2:-<span class="hljs-variable">$DEFAULT_TAG</span>&#125;</span><br>MODE=<span class="hljs-variable">$&#123;3:-<span class="hljs-variable">$DEFAULT_MODE</span>&#125;</span><br>IMAGE_NAME=<span class="hljs-variable">$&#123;4:-<span class="hljs-variable">$DEFAULT_IMAGE</span>&#125;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;====== 构建 Ubuntu Docker 镜像 ======&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Ubuntu Release : <span class="hljs-variable">$UBUNTU_RELEASE</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Docker Tag     : <span class="hljs-variable">$TAG</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;模式           : <span class="hljs-variable">$MODE</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;镜像名         : <span class="hljs-variable">$IMAGE_NAME</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;架构           : <span class="hljs-variable">$ARCH</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;镜像源         : <span class="hljs-variable">$MIRROR</span>&quot;</span><br><span class="hljs-built_in">echo</span><br><br><span class="hljs-comment"># 检查 debootstrap 是否安装</span><br><span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v debootstrap &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;⚠️ 未找到 debootstrap，正在安装...&quot;</span><br>    sudo apt-get update &amp;&amp; sudo apt-get install -y debootstrap<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 创建 rootfs</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 开始构建 rootfs...&quot;</span><br>sudo <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$ROOTFS_DIR</span><br>sudo debootstrap --<span class="hljs-built_in">arch</span>=<span class="hljs-variable">$ARCH</span> <span class="hljs-variable">$UBUNTU_RELEASE</span> <span class="hljs-variable">$ROOTFS_DIR</span> <span class="hljs-variable">$MIRROR</span><br><br><span class="hljs-comment"># 打包 rootfs 并导入临时镜像</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 打包 rootfs...&quot;</span><br>sudo tar -C <span class="hljs-variable">$ROOTFS_DIR</span> -c . | docker import - <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$TAG</span><br><br><span class="hljs-comment"># 根据模式决定是否安装工具</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$MODE</span>&quot;</span> = <span class="hljs-string">&quot;--full&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 构建 FULL 模式镜像，安装常用工具...&quot;</span><br>    <span class="hljs-built_in">cat</span> &gt; Dockerfile &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">FROM $&#123;IMAGE_NAME&#125;-base:$TAG</span><br><span class="hljs-string"></span><br><span class="hljs-string">ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai</span><br><span class="hljs-string"></span><br><span class="hljs-string">RUN apt-get update &amp;&amp; apt-get install -y \\</span><br><span class="hljs-string">    vim curl wget net-tools iputils-ping less lsb-release ca-certificates \\</span><br><span class="hljs-string">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="hljs-string"></span><br><span class="hljs-string">CMD [&quot;/bin/bash&quot;]</span><br><span class="hljs-string">EOF</span><br><br>    docker build -t <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$TAG</span> .<br>    <span class="hljs-built_in">rm</span> -f Dockerfile<br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 构建 MINIMAL 模式镜像...&quot;</span><br>    docker tag <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$TAG</span> <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$TAG</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 清理</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 清理临时文件...&quot;</span><br><span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$ROOTFS_DIR</span><br>docker rmi <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$TAG</span> &gt;/dev/null 2&gt;&amp;1 || <span class="hljs-literal">true</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✅ 镜像构建完成！&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;你现在可以运行: docker run -it <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$TAG</span> /bin/bash&quot;</span><br><br></code></pre></td></tr></table></figure>
<p>使用方法:</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-number">1.</span> 构建 Ubuntu <span class="hljs-number">20.04</span> 纯净版（默认镜像名 <span class="hljs-keyword">my</span>-ubuntu）：<br>./build-ubuntu-image.sh focal <span class="hljs-number">20.04</span> <span class="hljs-comment">--minimal</span><br><br><span class="hljs-number">2.</span> 构建 Ubuntu <span class="hljs-number">22.04</span> 工具增强版，镜像名自定义为 <span class="hljs-keyword">my</span>-ubuntu-dev：<br>./build-ubuntu-image.sh jammy <span class="hljs-number">22.04</span> <span class="hljs-comment">--full my-ubuntu-dev</span><br><br><span class="hljs-number">3.</span> 构建 Ubuntu <span class="hljs-number">24.04</span>，保持默认（full 模式，镜像名 <span class="hljs-keyword">my</span>-ubuntu）：<br>./build-ubuntu-image.sh noble <span class="hljs-number">24.04</span><br><br><span class="hljs-number">4.</span> 查看镜像：<br>docker images<br><span class="hljs-number">5.</span> 启动容器并测试：<br>docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> <span class="hljs-keyword">my</span>-ubuntu-dev:<span class="hljs-number">22.04</span> /bin/bash<br></code></pre></td></tr></table></figure>
<h5 id="全自动化脚本一键生成-ubuntu-docker-镜像支持">5.
<strong>全自动化脚本</strong>，一键生成 Ubuntu Docker 镜像，支持：</h5>
<ul>
<li>选择 Ubuntu 版本（focal / jammy / noble）</li>
<li>选择模式：<code>--minimal</code> 或
<code>--full</code>（是否预装常用工具）</li>
<li>自定义 Docker 镜像名称</li>
<li>可自定义 apt 镜像源（国内/官方）</li>
</ul>
<p>build-ubuntu-image.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>set -e<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">==============================</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">一键构建 Ubuntu Docker 镜像</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  ./build-ubuntu-image.sh [release] [tag] [mode] [imagename] [mirror]</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">示例:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  ./build-ubuntu-image.sh jammy 22.04 --full my-ubuntu-dev https://mirrors.tuna.tsinghua.edu.cn/ubuntu/</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">==============================</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">默认参数</span><br>DEFAULT_RELEASE=focal<br>DEFAULT_TAG=20.04<br>DEFAULT_MODE=--full<br>DEFAULT_IMAGE=my-ubuntu<br>DEFAULT_MIRROR=https://mirrors.tuna.tsinghua.edu.cn/ubuntu/<br>ARCH=amd64<br>ROOTFS_DIR=ubuntu-rootfs<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">读取参数</span><br>UBUNTU_RELEASE=$&#123;1:-$DEFAULT_RELEASE&#125;<br>TAG=$&#123;2:-$DEFAULT_TAG&#125;<br>MODE=$&#123;3:-$DEFAULT_MODE&#125;<br>IMAGE_NAME=$&#123;4:-$DEFAULT_IMAGE&#125;<br>MIRROR=$&#123;5:-$DEFAULT_MIRROR&#125;<br><br>echo &quot;====== 构建 Ubuntu Docker 镜像 ======&quot;<br>echo &quot;Ubuntu Release : $UBUNTU_RELEASE&quot;<br>echo &quot;Docker Tag     : $TAG&quot;<br>echo &quot;模式           : $MODE&quot;<br>echo &quot;镜像名         : $IMAGE_NAME&quot;<br>echo &quot;APT 镜像源     : $MIRROR&quot;<br>echo &quot;架构           : $ARCH&quot;<br>echo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查 debootstrap 是否安装</span><br>if ! command -v debootstrap &gt;/dev/null 2&gt;&amp;1; then<br>    echo &quot;⚠️ 未找到 debootstrap，正在安装...&quot;<br>    sudo apt-get update &amp;&amp; sudo apt-get install -y debootstrap<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建 rootfs</span><br>echo &quot;👉 开始构建 rootfs...&quot;<br>sudo rm -rf $ROOTFS_DIR<br>sudo debootstrap --arch=$ARCH $UBUNTU_RELEASE $ROOTFS_DIR $MIRROR<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">打包 rootfs 并导入临时镜像</span><br>echo &quot;👉 打包 rootfs...&quot;<br>sudo tar -C $ROOTFS_DIR -c . | docker import - $&#123;IMAGE_NAME&#125;-base:$TAG<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">根据模式决定是否安装工具</span><br>if [ &quot;$MODE&quot; = &quot;--full&quot; ]; then<br>    echo &quot;👉 构建 FULL 模式镜像，安装常用工具...&quot;<br>    cat &gt; Dockerfile &lt;&lt;EOF<br>FROM $&#123;IMAGE_NAME&#125;-base:$TAG<br><br>ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai<br><br>RUN apt-get update &amp;&amp; apt-get install -y \\<br>    vim curl wget net-tools iputils-ping less lsb-release ca-certificates \\<br>    &amp;&amp; rm -rf /var/lib/apt/lists/*<br><br>CMD [&quot;/bin/bash&quot;]<br>EOF<br><br>    docker build -t $IMAGE_NAME:$TAG .<br>    rm -f Dockerfile<br>else<br>    echo &quot;👉 构建 MINIMAL 模式镜像...&quot;<br>    docker tag $&#123;IMAGE_NAME&#125;-base:$TAG $IMAGE_NAME:$TAG<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理</span><br>echo &quot;👉 清理临时文件...&quot;<br>rm -rf $ROOTFS_DIR<br>docker rmi $&#123;IMAGE_NAME&#125;-base:$TAG &gt;/dev/null 2&gt;&amp;1 || true<br><br>echo &quot;✅ 镜像构建完成！&quot;<br>echo &quot;你现在可以运行: docker run -it $IMAGE_NAME:$TAG /bin/bash&quot;<br><br></code></pre></td></tr></table></figure>
<p>使用方法:</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">构建 Ubuntu 20.04 最小版：<br><br><span class="hljs-string">./build-ubuntu-image.sh</span> focal 20.04 <span class="hljs-params">--minimal</span><br><br><br>构建 Ubuntu 22.04 工具增强版，自定义镜像名 my-ubuntu-dev：<br><br><span class="hljs-string">./build-ubuntu-image.sh</span> jammy 22.04 <span class="hljs-params">--full</span> my-ubuntu-dev<br><br><br>构建 Ubuntu 24.04，使用阿里云镜像源：<br><br><span class="hljs-string">./build-ubuntu-image.sh</span> noble 24.04 <span class="hljs-params">--full</span> my-ubuntu-24 https:<span class="hljs-string">//mirrors.aliyun.com/ubuntu/</span><br><br><br>查看镜像：<br><br>docker images<br><br><br>启动容器：<br><br>docker run -it my-ubuntu-dev<span class="hljs-function">:22.04</span> <span class="hljs-string">/bin/bash</span><br></code></pre></td></tr></table></figure>
<h4 id="问题排查">问题排查</h4>
<p>如果你在执行脚本过程中，遇到 E: No such script:
/usr/share/debootstrap/scripts/focal 这个错误。 说明<strong>你的系统里
debootstrap 没有 focal 的脚本</strong>。这是 debootstrap
的常见问题，尤其在一些老版本或非 Ubuntu 系统上。可以这样解决：</p>
<ol type="1">
<li><p>解决方法一：安装最新版 debootstrap</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo apt-<span class="hljs-built_in">get</span> update<br>sudo apt-<span class="hljs-built_in">get</span> install -y debootstrap<br><br></code></pre></td></tr></table></figure></li>
<li><p>解决方法二：使用现有脚本代替</p>
<p>如果你没有 <code>focal</code>，可以使用类似版本（例如
<code>jammy</code> 或 <code>bionic</code>）来代替：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo debootstrap --<span class="hljs-built_in">arch</span>=amd64 jammy ./ubuntu-rootfs https://mirrors.tuna.tsinghua.edu.cn/ubuntu/<br></code></pre></td></tr></table></figure>
<blockquote>
<p>注：Jammy = 22.04，Bionic = 18.04</p>
</blockquote></li>
<li><p>解决方法三：手动下载脚本</p>
<p>如果非 Ubuntu 系统，也可以手动下载 debootstrap 脚本：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo wget https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/debootstrap/</span>debootstrap<span class="hljs-regexp">/master/</span>scripts<span class="hljs-regexp">/focal -O /u</span>sr<span class="hljs-regexp">/share/</span>debootstrap<span class="hljs-regexp">/scripts/</span>focal<br></code></pre></td></tr></table></figure>
<p>然后就可以用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo debootstrap --<span class="hljs-built_in">arch</span>=amd64 focal ./ubuntu-rootfs http://archive.ubuntu.com/ubuntu/<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="改进1">改进1</h4>
<p>升级脚本，让它 <strong>即使系统 debootstrap
没有指定版本</strong>，也能自动下载对应的脚本来构建 rootfs，从而支持任意
Ubuntu 版本。</p>
<p>build-ubuntu-image.sh（支持自动下载 debootstrap 脚本）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">set</span> -e<br><br><span class="hljs-comment"># ==============================</span><br><span class="hljs-comment"># 一键构建 Ubuntu Docker 镜像（自动下载缺失 debootstrap 脚本）</span><br><span class="hljs-comment"># 使用:</span><br><span class="hljs-comment">#   ./build-ubuntu-image.sh [release] [tag] [mode] [imagename] [mirror]</span><br><span class="hljs-comment"># 示例:</span><br><span class="hljs-comment">#   ./build-ubuntu-image.sh jammy 22.04 --full my-ubuntu-dev</span><br><span class="hljs-comment"># ==============================</span><br><br><span class="hljs-comment"># 默认参数</span><br>DEFAULT_RELEASE=focal<br>DEFAULT_TAG=20.04<br>DEFAULT_MODE=--full<br>DEFAULT_IMAGE=my-ubuntu<br>DEFAULT_MIRROR=https://mirrors.tuna.tsinghua.edu.cn/ubuntu/<br>ARCH=amd64<br>ROOTFS_DIR=ubuntu-rootfs<br>SCRIPTS_DIR=/usr/share/debootstrap/scripts<br>DEBOOTSTRAP_GIT=https://raw.githubusercontent.com/debootstrap/debootstrap/master/scripts<br><br><span class="hljs-comment"># 读取参数</span><br>USER_RELEASE=<span class="hljs-variable">$&#123;1:-<span class="hljs-variable">$DEFAULT_RELEASE</span>&#125;</span><br>TAG=<span class="hljs-variable">$&#123;2:-<span class="hljs-variable">$DEFAULT_TAG</span>&#125;</span><br>MODE=<span class="hljs-variable">$&#123;3:-<span class="hljs-variable">$DEFAULT_MODE</span>&#125;</span><br>IMAGE_NAME=<span class="hljs-variable">$&#123;4:-<span class="hljs-variable">$DEFAULT_IMAGE</span>&#125;</span><br>MIRROR=<span class="hljs-variable">$&#123;5:-<span class="hljs-variable">$DEFAULT_MIRROR</span>&#125;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;====== 构建 Ubuntu Docker 镜像 ======&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;用户输入版本 : <span class="hljs-variable">$USER_RELEASE</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Docker Tag    : <span class="hljs-variable">$TAG</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;模式          : <span class="hljs-variable">$MODE</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;镜像名        : <span class="hljs-variable">$IMAGE_NAME</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;APT 镜像源    : <span class="hljs-variable">$MIRROR</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;架构          : <span class="hljs-variable">$ARCH</span>&quot;</span><br><span class="hljs-built_in">echo</span><br><br><span class="hljs-comment"># 检查 debootstrap 是否安装</span><br><span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v debootstrap &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;⚠️ 未找到 debootstrap，正在安装...&quot;</span><br>    sudo apt-get update &amp;&amp; sudo apt-get install -y debootstrap wget<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 检查脚本是否存在</span><br><span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">&quot;<span class="hljs-variable">$SCRIPTS_DIR</span>/<span class="hljs-variable">$USER_RELEASE</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;⚠️ debootstrap 脚本 <span class="hljs-variable">$USER_RELEASE</span> 不存在，自动下载...&quot;</span><br>    sudo wget -O <span class="hljs-string">&quot;<span class="hljs-variable">$SCRIPTS_DIR</span>/<span class="hljs-variable">$USER_RELEASE</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$DEBOOTSTRAP_GIT</span>/<span class="hljs-variable">$USER_RELEASE</span>&quot;</span><br>    <span class="hljs-keyword">if</span> [ $? -ne 0 ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;❌ 下载失败，请检查网络或版本名是否正确。&quot;</span><br>        <span class="hljs-built_in">exit</span> 1<br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 创建 rootfs</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 开始构建 rootfs...&quot;</span><br>sudo <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$ROOTFS_DIR</span><br>sudo debootstrap --<span class="hljs-built_in">arch</span>=<span class="hljs-variable">$ARCH</span> <span class="hljs-variable">$USER_RELEASE</span> <span class="hljs-variable">$ROOTFS_DIR</span> <span class="hljs-variable">$MIRROR</span><br><br><span class="hljs-comment"># 打包 rootfs 并导入临时镜像</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 打包 rootfs...&quot;</span><br>sudo tar -C <span class="hljs-variable">$ROOTFS_DIR</span> -c . | docker import - <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$TAG</span><br><br><span class="hljs-comment"># 根据模式决定是否安装工具</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$MODE</span>&quot;</span> = <span class="hljs-string">&quot;--full&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 构建 FULL 模式镜像，安装常用工具...&quot;</span><br>    <span class="hljs-built_in">cat</span> &gt; Dockerfile &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">FROM $&#123;IMAGE_NAME&#125;-base:$TAG</span><br><span class="hljs-string"></span><br><span class="hljs-string">ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai</span><br><span class="hljs-string"></span><br><span class="hljs-string">RUN apt-get update &amp;&amp; apt-get install -y \\</span><br><span class="hljs-string">    vim curl wget net-tools iputils-ping less lsb-release ca-certificates \\</span><br><span class="hljs-string">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="hljs-string"></span><br><span class="hljs-string">CMD [&quot;/bin/bash&quot;]</span><br><span class="hljs-string">EOF</span><br><br>    docker build -t <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$TAG</span> .<br>    <span class="hljs-built_in">rm</span> -f Dockerfile<br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 构建 MINIMAL 模式镜像...&quot;</span><br>    docker tag <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$TAG</span> <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$TAG</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 清理</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 清理临时文件...&quot;</span><br><span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$ROOTFS_DIR</span><br>docker rmi <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$TAG</span> &gt;/dev/null 2&gt;&amp;1 || <span class="hljs-literal">true</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✅ 镜像构建完成！&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;你现在可以运行: docker run -it <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$TAG</span> /bin/bash&quot;</span><br><br></code></pre></td></tr></table></figure>
<p>使用实例</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">构建 Ubuntu 20.04 FULL 模式：<br><br><span class="hljs-string">./build-ubuntu-image.sh</span> focal 20.04 <span class="hljs-params">--full</span> my-ubuntu-dev<br><br><br>构建 Ubuntu 22.04 MINIMAL 模式：<br><br><span class="hljs-string">./build-ubuntu-image.sh</span> jammy 22.04 <span class="hljs-params">--minimal</span> my-ubuntu-22<br><br><br>构建 Ubuntu 24.04，使用阿里云镜像源：<br><br><span class="hljs-string">./build-ubuntu-image.sh</span> noble 24.04 <span class="hljs-params">--full</span> my-ubuntu-24 https:<span class="hljs-string">//mirrors.aliyun.com/ubuntu/</span><br></code></pre></td></tr></table></figure>
<p>自动检测 debootstrap 脚本是否存在</p>
<p>不存在时自动从 GitHub 下载最新脚本</p>
<p>支持自定义 Ubuntu 版本、镜像名、模式（minimal/full）</p>
<p>支持自定义 apt 镜像源</p>
<p>FULL 模式会安装常用工具</p>
<p>执行上述脚本出现
https://raw.githubusercontent.com/debootstrap/debootstrap/master/scripts
404 由于 Ubuntu 官方的 debootstrap 脚本已不再维护 Ubuntu Focal（20.04
LTS），导致 <code>/usr/share/debootstrap/scripts/focal</code>
文件缺失。因此，无法直接使用 debootstrap 构建 Ubuntu 20.04 的
rootfs。</p>
<h4 id="改进2">改进2</h4>
<p>面临的问题：</p>
<ul>
<li>debootstrap 默认脚本可能缺失</li>
<li><strong>无法访问 Docker Hub</strong>，所以不能直接
<code>docker pull ubuntu:20.04</code></li>
<li>目标是 <strong>构建可用的 Ubuntu 镜像</strong></li>
</ul>
<p>在这种情况下，可以通过 <strong>离线方式</strong> 构建 Ubuntu Docker
镜像</p>
<p>使用官方 Ubuntu 根文件系统 tar 包（推荐）</p>
<p>Ubuntu 官方提供 <strong>rootfs tarball</strong>，可以离线下载：</p>
<ul>
<li>官网地址（可在可访问网络的机器下载，再传到目标机）：
<ul>
<li>https://partner-images.canonical.com/core/focal/current/</li>
<li>文件示例：<code>ubuntu-20.04-core-cloudimg-amd64-root.tar.gz</code></li>
</ul></li>
</ul>
<p>构建流程</p>
<ol type="1">
<li><p>下载 tar 包到目标机（通过 U 盘、内网服务器等方式传输）。</p></li>
<li><p>导入 Docker：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> import ubuntu-<span class="hljs-number">20</span>.<span class="hljs-number">04</span>-core-cloudimg-amd64-root.tar.gz my-ubuntu:<span class="hljs-number">20</span>.<span class="hljs-number">04</span><br></code></pre></td></tr></table></figure></li>
<li><p>验证：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> <span class="hljs-keyword">my</span>-ubuntu:<span class="hljs-number">20.04</span> /bin/bash<br></code></pre></td></tr></table></figure></li>
<li><p>可选：在 Dockerfile 中基于此镜像安装常用工具：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> my-ubuntu:<span class="hljs-number">20.04</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y vim curl wget iputils-ping net-tools &amp;&amp; <span class="hljs-built_in">rm</span> -rf /var/lib/apt/lists/*</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/bin/bash&quot;</span>]</span><br></code></pre></td></tr></table></figure></li>
</ol>
<p>✅ 优点：完全离线、可控、官方支持 ⚠️ 缺点：需要先下载 tar 包</p>
<p>2️⃣ 使用 <code>debootstrap</code> 离线构建（非 Ubuntu 系统）</p>
<p>即使你的系统不是 Ubuntu，也可以：</p>
<ol type="1">
<li><p>在可联网的 Ubuntu 系统上运行 <code>debootstrap</code> 构建
rootfs：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo debootstrap --<span class="hljs-built_in">arch</span>=amd64 focal ./ubuntu-rootfs http://archive.ubuntu.com/ubuntu/<br></code></pre></td></tr></table></figure></li>
<li><p>打包 rootfs：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">sudo tar -C ./ubuntu-rootfs -c . <span class="hljs-string">| gzip &gt; ubuntu-focal-rootfs.tar.gz</span><br></code></pre></td></tr></table></figure></li>
<li><p>复制 tar 包到目标系统。</p></li>
<li><p>导入 Docker：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cat</span> ubuntu-focal-rootfs.tar.gz | docker import - my-ubuntu:<span class="hljs-number">20</span>.<span class="hljs-number">04</span><br></code></pre></td></tr></table></figure></li>
</ol>
<p>✅ 优点：完全离线，支持任意系统 ⚠️ 缺点：需要额外的 Ubuntu 环境生成
rootfs</p>
<p>3️⃣ 使用现有 ISO 离线构建</p>
<ol type="1">
<li><p>下载 Ubuntu Server ISO（例如
<code>ubuntu-20.04-live-server-amd64.iso</code>）</p></li>
<li><p>挂载 ISO：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> mount -o loop ubuntu-<span class="hljs-number">20</span>.<span class="hljs-number">04</span>.iso /mnt<br></code></pre></td></tr></table></figure></li>
<li><p>提取 squashfs 文件系统：</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nsis">sudo unsquashfs -d ubuntu-rootfs /mnt/casper/<span class="hljs-keyword">file</span><span class="hljs-params">system</span>.squashfs<br></code></pre></td></tr></table></figure></li>
<li><p>打包 rootfs：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> tar -C ubuntu-rootfs -c . | docker import - my-ubuntu:<span class="hljs-number">20</span>.<span class="hljs-number">04</span><br></code></pre></td></tr></table></figure></li>
</ol>
<p>✅ 优点：完全离线，不依赖 Docker Hub ⚠️ 缺点：ISO
提取可能比较复杂</p>
<p>💡 总结</p>
<table>

<thead>
<tr>
<th>方法</th>
<th>是否可离线</th>
<th>是否官方支持</th>
<th>难易度</th>
</tr>
</thead>
<tbody>
<tr>
<td>官方 rootfs tar</td>
<td>✅</td>
<td>✅</td>
<td>简单</td>
</tr>
<tr>
<td>debootstrap 离线</td>
<td>✅</td>
<td>✅</td>
<td>中等，需要 Ubuntu 环境</td>
</tr>
<tr>
<td>ISO 提取</td>
<td>✅</td>
<td>✅</td>
<td>较复杂</td>
</tr>
</tbody>
</table>
<p>完整脚本（带本机缓存管理）offline-ubuntu-docker-auto-v4.sh</p>
<p>每次构建镜像时，会在 <code>$HOME/.offline-ubuntu-cache</code> 保存
rootfs</p>
<p>下次同版本同架构直接使用缓存</p>
<p>自动删除超过 N 天的老缓存（避免占用过多磁盘空间）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">set</span> -e<br><br><span class="hljs-comment"># ==============================</span><br><span class="hljs-comment"># 离线构建 Ubuntu Docker 镜像（自动检测版本/架构，FULL 模式安装工具，本机缓存管理）</span><br><span class="hljs-comment"># 使用:</span><br><span class="hljs-comment">#   ./offline-ubuntu-docker-auto-v4.sh &lt;source&gt; &lt;type&gt; &lt;tag&gt; &lt;mode&gt; &lt;imagename&gt;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 参数:</span><br><span class="hljs-comment">#   source    : rootfs tar 文件路径 或 ISO 文件路径</span><br><span class="hljs-comment">#   type      : tar 或 iso</span><br><span class="hljs-comment">#   tag       : Docker 镜像 tag (如 20.04)</span><br><span class="hljs-comment">#   mode      : --minimal 或 --full</span><br><span class="hljs-comment">#   imagename : Docker 镜像名 (默认 my-ubuntu)</span><br><span class="hljs-comment"># ==============================</span><br><br>SOURCE_FILE=<span class="hljs-variable">$1</span><br>TYPE=<span class="hljs-variable">$2</span><br>TAG=<span class="hljs-variable">$&#123;3:-latest&#125;</span><br>MODE=<span class="hljs-variable">$&#123;4:---full&#125;</span><br>IMAGE_NAME=<span class="hljs-variable">$&#123;5:-my-ubuntu&#125;</span><br>CACHE_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$HOME</span>/.offline-ubuntu-cache&quot;</span><br>ROOTFS_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$CACHE_DIR</span>/rootfs-<span class="hljs-variable">$TAG</span>&quot;</span><br>CACHE_MAX_DAYS=30   <span class="hljs-comment"># 自动清理超过30天的缓存</span><br><br><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$SOURCE_FILE</span>&quot;</span> ] || [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$TYPE</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;❌ 参数错误！请提供 source 文件路径和类型 (tar/iso)&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$CACHE_DIR</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;====== 离线构建 Ubuntu Docker 镜像 ======&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;源文件       : <span class="hljs-variable">$SOURCE_FILE</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;类型         : <span class="hljs-variable">$TYPE</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Docker Tag   : <span class="hljs-variable">$TAG</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;模式         : <span class="hljs-variable">$MODE</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;镜像名       : <span class="hljs-variable">$IMAGE_NAME</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;缓存目录     : <span class="hljs-variable">$CACHE_DIR</span>&quot;</span><br><span class="hljs-built_in">echo</span><br><br><span class="hljs-comment"># 清理过期缓存</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 清理超过 <span class="hljs-variable">$CACHE_MAX_DAYS</span> 天的缓存...&quot;</span><br>find <span class="hljs-variable">$CACHE_DIR</span> -maxdepth 1 -<span class="hljs-built_in">type</span> d -name <span class="hljs-string">&quot;rootfs-*&quot;</span> -mtime +<span class="hljs-variable">$CACHE_MAX_DAYS</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -rf &#123;&#125; \;<br><br><span class="hljs-comment"># 检查缓存</span><br><span class="hljs-keyword">if</span> [ -d <span class="hljs-string">&quot;<span class="hljs-variable">$ROOTFS_DIR</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✅ 检测到缓存 rootfs，直接使用缓存...&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-comment"># 清理旧 rootfs</span><br>    <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$ROOTFS_DIR</span><br>    <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$ROOTFS_DIR</span><br><br>    <span class="hljs-comment"># 提取 rootfs</span><br>    <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$TYPE</span>&quot;</span> = <span class="hljs-string">&quot;tar&quot;</span> ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 导入 rootfs tar...&quot;</span><br>        sudo tar -C <span class="hljs-variable">$ROOTFS_DIR</span> -xf <span class="hljs-variable">$SOURCE_FILE</span><br>    <span class="hljs-keyword">elif</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$TYPE</span>&quot;</span> = <span class="hljs-string">&quot;iso&quot;</span> ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 挂载 ISO 提取 squashfs...&quot;</span><br>        MOUNT_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$CACHE_DIR</span>/iso-mount-<span class="hljs-variable">$TAG</span>&quot;</span><br>        <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$MOUNT_DIR</span><br>        sudo mount -o loop <span class="hljs-variable">$SOURCE_FILE</span> <span class="hljs-variable">$MOUNT_DIR</span><br>        <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">&quot;<span class="hljs-variable">$MOUNT_DIR</span>/casper/filesystem.squashfs&quot;</span> ]; <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;❌ ISO 中未找到 casper/filesystem.squashfs&quot;</span><br>            <span class="hljs-built_in">exit</span> 1<br>        <span class="hljs-keyword">fi</span><br>        sudo unsquashfs -d <span class="hljs-variable">$ROOTFS_DIR</span> <span class="hljs-variable">$MOUNT_DIR</span>/casper/filesystem.squashfs<br>        sudo umount <span class="hljs-variable">$MOUNT_DIR</span><br>        <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$MOUNT_DIR</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;❌ 类型必须是 tar 或 iso&quot;</span><br>        <span class="hljs-built_in">exit</span> 1<br>    <span class="hljs-keyword">fi</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✅ rootfs 已缓存到 <span class="hljs-variable">$ROOTFS_DIR</span>&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 自动检测 Ubuntu 版本</span><br><span class="hljs-keyword">if</span> [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$ROOTFS_DIR</span>/etc/os-release&quot;</span> ]; <span class="hljs-keyword">then</span><br>    UBUNTU_VERSION=$(grep <span class="hljs-string">&#x27;VERSION_ID=&#x27;</span> <span class="hljs-variable">$ROOTFS_DIR</span>/etc/os-release | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27;&quot;&#x27;</span> -f2)<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 检测到 Ubuntu 版本: <span class="hljs-variable">$UBUNTU_VERSION</span>&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;⚠️ 无法检测 Ubuntu 版本，使用默认 tag: <span class="hljs-variable">$TAG</span>&quot;</span><br>    UBUNTU_VERSION=<span class="hljs-variable">$TAG</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 自动检测架构</span><br><span class="hljs-keyword">if</span> [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$ROOTFS_DIR</span>/usr/bin/file&quot;</span> ]; <span class="hljs-keyword">then</span><br>    ARCH=$(file -bL <span class="hljs-variable">$ROOTFS_DIR</span>/bin/bash | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>)<br><span class="hljs-keyword">else</span><br>    ARCH=<span class="hljs-string">&quot;amd64&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 检测到架构: <span class="hljs-variable">$ARCH</span>&quot;</span><br><br><span class="hljs-comment"># 导入临时 Docker 镜像</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 导入 Docker 临时镜像...&quot;</span><br>sudo tar -C <span class="hljs-variable">$ROOTFS_DIR</span> -c . | docker import - <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$UBUNTU_VERSION</span><br><br><span class="hljs-comment"># FULL 模式安装常用工具</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$MODE</span>&quot;</span> = <span class="hljs-string">&quot;--full&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 FULL 模式: 安装常用工具...&quot;</span><br>    <span class="hljs-built_in">cat</span> &gt; Dockerfile &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">FROM $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION</span><br><span class="hljs-string">ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai</span><br><span class="hljs-string">RUN dpkg --add-architecture $ARCH || true</span><br><span class="hljs-string">RUN apt-get update &amp;&amp; apt-get install -y \\</span><br><span class="hljs-string">    vim curl wget net-tools iputils-ping less lsb-release ca-certificates \\</span><br><span class="hljs-string">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="hljs-string">CMD [&quot;/bin/bash&quot;]</span><br><span class="hljs-string">EOF</span><br><br>    docker build -t <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$UBUNTU_VERSION</span> .<br>    <span class="hljs-built_in">rm</span> -f Dockerfile<br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 MINIMAL 模式: 不安装额外工具&quot;</span><br>    docker tag <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$UBUNTU_VERSION</span> <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$UBUNTU_VERSION</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 清理临时镜像</span><br>docker rmi <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$UBUNTU_VERSION</span> &gt;/dev/null 2&gt;&amp;1 || <span class="hljs-literal">true</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✅ 镜像构建完成！&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;运行示例: docker run -it <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$UBUNTU_VERSION</span> /bin/bash&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;缓存 rootfs 路径: <span class="hljs-variable">$ROOTFS_DIR</span>&quot;</span><br><br></code></pre></td></tr></table></figure>
<p>使用示例：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs stylus">使用 tar 构建 FULL 模式<br><br>./offline-ubuntu-docker-auto-v4<span class="hljs-selector-class">.sh</span> ubuntu-<span class="hljs-number">20.04</span>-core-rootfs<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span> tar <span class="hljs-number">20.04</span> <span class="hljs-attr">--full</span> my-ubuntu<br><br><br>使用 ISO 构建 MINIMAL 模式<br><br>./offline-ubuntu-docker-auto-v4<span class="hljs-selector-class">.sh</span> ubuntu-<span class="hljs-number">22.04</span>-live-server-amd64<span class="hljs-selector-class">.iso</span> iso <span class="hljs-number">22.04</span> <span class="hljs-attr">--minimal</span> my-ubuntu<br><br><br>运行容器<br><br>docker run -it my-ubuntu:<span class="hljs-number">20.04</span> /bin/bash<br><br></code></pre></td></tr></table></figure>
<p>新增功能</p>
<ul>
<li><strong>本机缓存管理</strong>：<code>$HOME/.offline-ubuntu-cache</code></li>
<li>自动清理 <strong>超过 30 天的旧 rootfs</strong></li>
<li>下次构建同版本直接使用缓存，速度极快</li>
<li>FULL 模式自动安装工具，并支持自动检测架构</li>
</ul>
<h4 id="改进3">改进3</h4>
<p>执行上述脚本 出现 “container_linux.go:247: starting container process
caused "exec: "/bin/sh": stat /bin/sh: no such file or directory" oci
runtime error: container_linux.go:247: starting container process caused
"exec: "/bin/sh": stat /bin/sh: no such file or directory"” 错误。</p>
<p>说明 <strong>Docker 容器里没有 <code>/bin/sh</code>
或者路径不对</strong>。常见原因和解决方法如下：</p>
<p>1.<strong>rootfs 或 ISO 不是完整的 Ubuntu 根文件系统</strong></p>
<ul>
<li>有些 ISO（比如 Live
ISO）里面的根文件系统不是标准路径，或者是只读压缩系统（squashfs）未正确解压。</li>
<li>导入 Docker 后 <code>/bin/sh</code>
可能不存在，导致容器无法启动。</li>
</ul>
<p>2.<strong>解压或导入过程出错</strong></p>
<ul>
<li>可能你导入了部分文件夹，缺少 <code>/bin/bash</code> 或
<code>/bin/sh</code>。</li>
<li>使用 tar 导入时，需要确保 <code>tar -C &lt;dir&gt; -c .</code>
的路径是 <strong>完整 rootfs</strong> 根目录。</li>
</ul>
<p>3.<strong>架构不匹配</strong></p>
<ul>
<li>比如你导入了 <code>arm64</code> rootfs，在 x86_64 Docker
上运行，容器无法启动。</li>
</ul>
<p>把脚本升级，保证导入 Docker 的 rootfs <strong>一定包含
<code>/bin/bash</code> 或 <code>/bin/sh</code></strong>，并在 FULL
模式下自动验证架构和 shell。</p>
<p>同时，如果 shell 不存在，脚本会自动提示并停止，避免容器启动失败。</p>
<p>offline-ubuntu-docker-safe.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>set -e<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">==============================</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">离线构建 Ubuntu Docker 镜像（保证 /bin/sh 或 /bin/bash 存在）</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">自动检测版本/架构，FULL 模式安装工具，本机缓存管理</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  ./offline-ubuntu-docker-safe.sh &lt;<span class="hljs-built_in">source</span>&gt; &lt;<span class="hljs-built_in">type</span>&gt; &lt;tag&gt; &lt;mode&gt; &lt;imagename&gt;</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">==============================</span><br><br>SOURCE_FILE=$1<br>TYPE=$2<br>TAG=$&#123;3:-latest&#125;<br>MODE=$&#123;4:---full&#125;<br>IMAGE_NAME=$&#123;5:-my-ubuntu&#125;<br>CACHE_DIR=&quot;$HOME/.offline-ubuntu-cache&quot;<br>ROOTFS_DIR=&quot;$CACHE_DIR/rootfs-$TAG&quot;<br>CACHE_MAX_DAYS=30   # 自动清理超过30天的缓存<br><br>if [ -z &quot;$SOURCE_FILE&quot; ] || [ -z &quot;$TYPE&quot; ]; then<br>    echo &quot;❌ 参数错误！请提供 source 文件路径和类型 (tar/iso)&quot;<br>    exit 1<br>fi<br><br>mkdir -p $CACHE_DIR<br><br>echo &quot;====== 离线构建 Ubuntu Docker 镜像 ======&quot;<br>echo &quot;源文件       : $SOURCE_FILE&quot;<br>echo &quot;类型         : $TYPE&quot;<br>echo &quot;Docker Tag   : $TAG&quot;<br>echo &quot;模式         : $MODE&quot;<br>echo &quot;镜像名       : $IMAGE_NAME&quot;<br>echo &quot;缓存目录     : $CACHE_DIR&quot;<br>echo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理过期缓存</span><br>echo &quot;👉 清理超过 $CACHE_MAX_DAYS 天的缓存...&quot;<br>find $CACHE_DIR -maxdepth 1 -type d -name &quot;rootfs-*&quot; -mtime +$CACHE_MAX_DAYS -exec rm -rf &#123;&#125; \;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查缓存</span><br>if [ -d &quot;$ROOTFS_DIR&quot; ]; then<br>    echo &quot;✅ 检测到缓存 rootfs，直接使用缓存...&quot;<br>else<br>    rm -rf $ROOTFS_DIR<br>    mkdir -p $ROOTFS_DIR<br><br>    # 提取 rootfs<br>    if [ &quot;$TYPE&quot; = &quot;tar&quot; ]; then<br>        echo &quot;👉 导入 rootfs tar...&quot;<br>        sudo tar -C $ROOTFS_DIR -xf $SOURCE_FILE<br>    elif [ &quot;$TYPE&quot; = &quot;iso&quot; ]; then<br>        echo &quot;👉 挂载 ISO 提取 squashfs...&quot;<br>        MOUNT_DIR=&quot;$CACHE_DIR/iso-mount-$TAG&quot;<br>        mkdir -p $MOUNT_DIR<br>        sudo mount -o loop $SOURCE_FILE $MOUNT_DIR<br>        if [ ! -f &quot;$MOUNT_DIR/casper/filesystem.squashfs&quot; ]; then<br>            echo &quot;❌ ISO 中未找到 casper/filesystem.squashfs&quot;<br>            exit 1<br>        fi<br>        sudo unsquashfs -d $ROOTFS_DIR $MOUNT_DIR/casper/filesystem.squashfs<br>        sudo umount $MOUNT_DIR<br>        rm -rf $MOUNT_DIR<br>    else<br>        echo &quot;❌ 类型必须是 tar 或 iso&quot;<br>        exit 1<br>    fi<br>    echo &quot;✅ rootfs 已缓存到 $ROOTFS_DIR&quot;<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">自动检测 Ubuntu 版本</span><br>if [ -f &quot;$ROOTFS_DIR/etc/os-release&quot; ]; then<br>    UBUNTU_VERSION=$(grep &#x27;VERSION_ID=&#x27; $ROOTFS_DIR/etc/os-release | cut -d &#x27;&quot;&#x27; -f2)<br>    echo &quot;👉 检测到 Ubuntu 版本: $UBUNTU_VERSION&quot;<br>else<br>    echo &quot;⚠️ 无法检测 Ubuntu 版本，使用默认 tag: $TAG&quot;<br>    UBUNTU_VERSION=$TAG<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">自动检测架构</span><br>if [ -f &quot;$ROOTFS_DIR/bin/bash&quot; ]; then<br>    ARCH=$(file -bL $ROOTFS_DIR/bin/bash | awk &#x27;&#123;print $2&#125;&#x27;)<br>elif [ -f &quot;$ROOTFS_DIR/bin/sh&quot; ]; then<br>    ARCH=$(file -bL $ROOTFS_DIR/bin/sh | awk &#x27;&#123;print $2&#125;&#x27;)<br>else<br>    echo &quot;❌ rootfs 缺少 /bin/sh 或 /bin/bash，无法构建 Docker 镜像！&quot;<br>    exit 1<br>fi<br>echo &quot;👉 检测到架构: $ARCH&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">导入临时 Docker 镜像</span><br>echo &quot;👉 导入 Docker 临时镜像...&quot;<br>sudo tar -C $ROOTFS_DIR -c . | docker import - $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">FULL 模式安装常用工具</span><br>if [ &quot;$MODE&quot; = &quot;--full&quot; ]; then<br>    echo &quot;👉 FULL 模式: 安装常用工具...&quot;<br>    cat &gt; Dockerfile &lt;&lt;EOF<br>FROM $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION<br>ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai<br>RUN dpkg --add-architecture $ARCH || true<br>RUN apt-get update &amp;&amp; apt-get install -y \\<br>    vim curl wget net-tools iputils-ping less lsb-release ca-certificates \\<br>    &amp;&amp; rm -rf /var/lib/apt/lists/*<br>CMD [&quot;/bin/bash&quot;]<br>EOF<br><br>    docker build -t $IMAGE_NAME:$UBUNTU_VERSION .<br>    rm -f Dockerfile<br>else<br>    echo &quot;👉 MINIMAL 模式: 不安装额外工具&quot;<br>    docker tag $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION $IMAGE_NAME:$UBUNTU_VERSION<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理临时镜像</span><br>docker rmi $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION &gt;/dev/null 2&gt;&amp;1 || true<br><br>echo &quot;✅ 镜像构建完成！&quot;<br>echo &quot;运行示例: docker run -it $IMAGE_NAME:$UBUNTU_VERSION /bin/bash&quot;<br>echo &quot;缓存 rootfs 路径: $ROOTFS_DIR&quot;<br><br></code></pre></td></tr></table></figure>
<p><strong>确保 <code>/bin/bash</code> 或 <code>/bin/sh</code>
存在</strong></p>
<ul>
<li>如果缺失，构建会停止并提示错误。</li>
</ul>
<p><strong>自动检测 Ubuntu 版本与架构</strong></p>
<ul>
<li>FULL 模式自动安装工具时会考虑架构。</li>
</ul>
<p><strong>本机缓存管理</strong></p>
<ul>
<li><code>$HOME/.offline-ubuntu-cache</code> 保存 rootfs</li>
<li>自动清理超过 30 天的缓存</li>
</ul>
<p><strong>支持 tar / ISO</strong></p>
<ul>
<li>ISO 会解压 squashfs 到完整 rootfs</li>
</ul>
<p><strong>FULL / MINIMAL 模式</strong></p>
<ul>
<li>FULL 模式自动安装 vim、curl、wget、ping 等常用工具</li>
<li>MINIMAL 模式保持干净 rootfs</li>
</ul>
<h4 id="改进4">改进4</h4>
<p>实现 <strong>直接使用 Ubuntu Live ISO 一键生成 Docker
镜像</strong>，无需 debootstrap，自动处理 squashfs 并保证
<code>/bin/bash</code> 或 <code>/bin/sh</code> 存在。</p>
<p>offline-ubuntu-docker-liveiso.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>set -e<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">==============================</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">离线构建 Ubuntu Docker 镜像（支持 Live ISO 一键构建）</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">自动检测版本/架构，FULL 模式安装工具，本机缓存管理</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  ./offline-ubuntu-docker-liveiso.sh &lt;<span class="hljs-built_in">source</span>&gt; &lt;<span class="hljs-built_in">type</span>&gt; &lt;tag&gt; &lt;mode&gt; &lt;imagename&gt;</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">参数:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  <span class="hljs-built_in">source</span>    : rootfs tar 文件路径 或 ISO 文件路径</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  <span class="hljs-built_in">type</span>      : tar 或 iso</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  tag       : Docker 镜像 tag (如 20.04)</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  mode      : --minimal 或 --full</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  imagename : Docker 镜像名 (默认 my-ubuntu)</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">==============================</span><br><br>SOURCE_FILE=$1<br>TYPE=$2<br>TAG=$&#123;3:-latest&#125;<br>MODE=$&#123;4:---full&#125;<br>IMAGE_NAME=$&#123;5:-my-ubuntu&#125;<br>CACHE_DIR=&quot;$HOME/.offline-ubuntu-cache&quot;<br>ROOTFS_DIR=&quot;$CACHE_DIR/rootfs-$TAG&quot;<br>CACHE_MAX_DAYS=30<br><br>if [ -z &quot;$SOURCE_FILE&quot; ] || [ -z &quot;$TYPE&quot; ]; then<br>    echo &quot;❌ 参数错误！请提供 source 文件路径和类型 (tar/iso)&quot;<br>    exit 1<br>fi<br><br>mkdir -p $CACHE_DIR<br><br>echo &quot;====== 离线构建 Ubuntu Docker 镜像 ======&quot;<br>echo &quot;源文件       : $SOURCE_FILE&quot;<br>echo &quot;类型         : $TYPE&quot;<br>echo &quot;Docker Tag   : $TAG&quot;<br>echo &quot;模式         : $MODE&quot;<br>echo &quot;镜像名       : $IMAGE_NAME&quot;<br>echo &quot;缓存目录     : $CACHE_DIR&quot;<br>echo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理过期缓存</span><br>echo &quot;👉 清理超过 $CACHE_MAX_DAYS 天的缓存...&quot;<br>find $CACHE_DIR -maxdepth 1 -type d -name &quot;rootfs-*&quot; -mtime +$CACHE_MAX_DAYS -exec rm -rf &#123;&#125; \;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查缓存</span><br>if [ -d &quot;$ROOTFS_DIR&quot; ]; then<br>    echo &quot;✅ 检测到缓存 rootfs，直接使用缓存...&quot;<br>else<br>    rm -rf $ROOTFS_DIR<br>    mkdir -p $ROOTFS_DIR<br><br>    if [ &quot;$TYPE&quot; = &quot;tar&quot; ]; then<br>        echo &quot;👉 导入 rootfs tar...&quot;<br>        sudo tar -C $ROOTFS_DIR -xf $SOURCE_FILE<br>    elif [ &quot;$TYPE&quot; = &quot;iso&quot; ]; then<br>        echo &quot;👉 挂载 ISO 提取 squashfs...&quot;<br>        MOUNT_DIR=&quot;$CACHE_DIR/iso-mount-$TAG&quot;<br>        mkdir -p $MOUNT_DIR<br>        sudo mount -o loop $SOURCE_FILE $MOUNT_DIR<br><br>        # 检查 squashfs<br>        SQUASHFS_PATH=$(find $MOUNT_DIR -name &quot;filesystem.squashfs&quot; | head -n1)<br>        if [ -z &quot;$SQUASHFS_PATH&quot; ]; then<br>            echo &quot;❌ ISO 中未找到 filesystem.squashfs&quot;<br>            exit 1<br>        fi<br><br>        echo &quot;👉 解压 squashfs 到 rootfs...&quot;<br>        sudo unsquashfs -d $ROOTFS_DIR $SQUASHFS_PATH<br>        sudo umount $MOUNT_DIR<br>        rm -rf $MOUNT_DIR<br>    else<br>        echo &quot;❌ 类型必须是 tar 或 iso&quot;<br>        exit 1<br>    fi<br>    echo &quot;✅ rootfs 已缓存到 $ROOTFS_DIR&quot;<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查 shell</span><br>if [ -f &quot;$ROOTFS_DIR/bin/bash&quot; ]; then<br>    SHELL_PATH=&quot;/bin/bash&quot;<br>elif [ -f &quot;$ROOTFS_DIR/bin/sh&quot; ]; then<br>    SHELL_PATH=&quot;/bin/sh&quot;<br>else<br>    echo &quot;❌ rootfs 缺少 /bin/sh 或 /bin/bash，无法构建 Docker 镜像！&quot;<br>    exit 1<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检测 Ubuntu 版本</span><br>if [ -f &quot;$ROOTFS_DIR/etc/os-release&quot; ]; then<br>    UBUNTU_VERSION=$(grep &#x27;VERSION_ID=&#x27; $ROOTFS_DIR/etc/os-release | cut -d &#x27;&quot;&#x27; -f2)<br>    echo &quot;👉 检测到 Ubuntu 版本: $UBUNTU_VERSION&quot;<br>else<br>    echo &quot;⚠️ 无法检测 Ubuntu 版本，使用默认 tag: $TAG&quot;<br>    UBUNTU_VERSION=$TAG<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">自动检测架构</span><br>ARCH=$(file -bL $ROOTFS_DIR$SHELL_PATH | awk &#x27;&#123;print $2&#125;&#x27;)<br>echo &quot;👉 检测到架构: $ARCH&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">导入 Docker 临时镜像</span><br>echo &quot;👉 导入 Docker 临时镜像...&quot;<br>sudo tar -C $ROOTFS_DIR -c . | docker import - $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">FULL 模式安装常用工具</span><br>if [ &quot;$MODE&quot; = &quot;--full&quot; ]; then<br>    echo &quot;👉 FULL 模式: 安装常用工具...&quot;<br>    cat &gt; Dockerfile &lt;&lt;EOF<br>FROM $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION<br>ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai<br>RUN dpkg --add-architecture $ARCH || true<br>RUN apt-get update &amp;&amp; apt-get install -y \\<br>    vim curl wget net-tools iputils-ping less lsb-release ca-certificates \\<br>    &amp;&amp; rm -rf /var/lib/apt/lists/*<br>CMD [&quot;$SHELL_PATH&quot;]<br>EOF<br><br>    docker build -t $IMAGE_NAME:$UBUNTU_VERSION .<br>    rm -f Dockerfile<br>else<br>    echo &quot;👉 MINIMAL 模式: 不安装额外工具&quot;<br>    docker tag $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION $IMAGE_NAME:$UBUNTU_VERSION<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理临时镜像</span><br>docker rmi $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION &gt;/dev/null 2&gt;&amp;1 || true<br><br>echo &quot;✅ 镜像构建完成！&quot;<br>echo &quot;运行示例: docker run -it $IMAGE_NAME:$UBUNTU_VERSION $SHELL_PATH&quot;<br>echo &quot;缓存 rootfs 路径: $ROOTFS_DIR&quot;<br><br></code></pre></td></tr></table></figure>
<ol type="1">
<li><strong>直接支持 Live ISO</strong>，无需 debootstrap</li>
<li><strong>自动解压 squashfs</strong>，生成完整 rootfs</li>
<li><strong>自动检测 shell</strong> (<code>/bin/bash</code> 或
<code>/bin/sh</code>)</li>
<li><strong>自动检测 Ubuntu 版本和架构</strong></li>
<li><strong>FULL / MINIMAL 模式</strong></li>
<li><strong>本机缓存管理</strong>，自动清理过期缓存</li>
</ol>
<p>🔹 使用示例</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># FULL 模式构建 ISO</span><br>./offline-ubuntu-docker-liveiso.sh ubuntu<span class="hljs-number">-22.04</span>-live-server-amd64.iso iso <span class="hljs-number">22.04</span> <span class="hljs-comment">--full my-ubuntu</span><br><br><span class="hljs-comment"># MINIMAL 模式构建 tar</span><br>./offline-ubuntu-docker-liveiso.sh ubuntu<span class="hljs-number">-20.04</span>-core-rootfs.tar.gz tar <span class="hljs-number">20.04</span> <span class="hljs-comment">--minimal my-ubuntu</span><br><br><span class="hljs-comment"># 运行容器</span><br>docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> <span class="hljs-keyword">my</span>-ubuntu:<span class="hljs-number">22.04</span> /bin/bash<br></code></pre></td></tr></table></figure>
<hr />
<p>这个脚本可以保证 <strong>容器一定有可用 shell</strong>，Live ISO
也能直接构建 Docker 镜像，无需额外网络或 debootstrap。</p>
<h4 id="改进5">改进5</h4>
<p>官网只有 ubuntu-focal-core-cloudimg-amd64-root.tar.gz 没有
ubuntu-20.04-core-rootfs.tar.gz。把脚本改成 <strong>直接兼容官方 cloud
image 命名</strong>，不用改名字就能直接构建 Docker 镜像，同时保留 Live
ISO 支持和 shell 检测功能。</p>
<p>offline-ubuntu-docker-auto-cloud.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>set -e<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">==============================</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">离线构建 Ubuntu Docker 镜像（兼容 cloud image 命名）</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">自动检测版本/架构，FULL 模式安装工具，本机缓存管理</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  ./offline-ubuntu-docker-auto-cloud.sh &lt;<span class="hljs-built_in">source</span>&gt; &lt;<span class="hljs-built_in">type</span>&gt; &lt;mode&gt; &lt;imagename&gt;</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">参数:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  <span class="hljs-built_in">source</span>    : rootfs tar 文件路径 或 ISO 文件路径</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  <span class="hljs-built_in">type</span>      : tar 或 iso</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  mode      : --minimal 或 --full</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">  imagename : Docker 镜像名 (默认 my-ubuntu)</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">==============================</span><br><br>SOURCE_FILE=$1<br>TYPE=$2<br>MODE=$&#123;3:---full&#125;<br>IMAGE_NAME=$&#123;4:-my-ubuntu&#125;<br>CACHE_DIR=&quot;$HOME/.offline-ubuntu-cache&quot;<br>CACHE_MAX_DAYS=30<br><br>if [ -z &quot;$SOURCE_FILE&quot; ] || [ -z &quot;$TYPE&quot; ]; then<br>    echo &quot;❌ 参数错误！请提供 source 文件路径和类型 (tar/iso)&quot;<br>    exit 1<br>fi<br><br>mkdir -p $CACHE_DIR<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">自动解析版本号</span><br>BASENAME=$(basename &quot;$SOURCE_FILE&quot;)<br>if [[ &quot;$BASENAME&quot; =~ ubuntu-([a-z]+)-core ]]; then<br>    UBUNTU_CODENAME=&quot;$&#123;BASH_REMATCH[1]&#125;&quot;<br>    case &quot;$UBUNTU_CODENAME&quot; in<br>        focal) UBUNTU_VERSION=&quot;20.04&quot; ;;<br>        jammy) UBUNTU_VERSION=&quot;22.04&quot; ;;<br>        bionic) UBUNTU_VERSION=&quot;18.04&quot; ;;<br>        *) UBUNTU_VERSION=&quot;latest&quot; ;;<br>    esac<br>else<br>    UBUNTU_VERSION=&quot;latest&quot;<br>fi<br><br>ROOTFS_DIR=&quot;$CACHE_DIR/rootfs-$UBUNTU_VERSION&quot;<br><br>echo &quot;====== 离线构建 Ubuntu Docker 镜像 ======&quot;<br>echo &quot;源文件       : $SOURCE_FILE&quot;<br>echo &quot;类型         : $TYPE&quot;<br>echo &quot;Docker Tag   : $UBUNTU_VERSION&quot;<br>echo &quot;模式         : $MODE&quot;<br>echo &quot;镜像名       : $IMAGE_NAME&quot;<br>echo &quot;缓存目录     : $CACHE_DIR&quot;<br>echo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理过期缓存</span><br>echo &quot;👉 清理超过 $CACHE_MAX_DAYS 天的缓存...&quot;<br>find $CACHE_DIR -maxdepth 1 -type d -name &quot;rootfs-*&quot; -mtime +$CACHE_MAX_DAYS -exec rm -rf &#123;&#125; \;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查缓存</span><br>if [ -d &quot;$ROOTFS_DIR&quot; ]; then<br>    echo &quot;✅ 检测到缓存 rootfs，直接使用缓存...&quot;<br>else<br>    rm -rf $ROOTFS_DIR<br>    mkdir -p $ROOTFS_DIR<br><br>    if [ &quot;$TYPE&quot; = &quot;tar&quot; ]; then<br>        echo &quot;👉 导入 rootfs tar...&quot;<br>        sudo tar -C $ROOTFS_DIR -xf $SOURCE_FILE<br>    elif [ &quot;$TYPE&quot; = &quot;iso&quot; ]; then<br>        echo &quot;👉 挂载 ISO 提取 squashfs...&quot;<br>        MOUNT_DIR=&quot;$CACHE_DIR/iso-mount-$UBUNTU_VERSION&quot;<br>        mkdir -p $MOUNT_DIR<br>        sudo mount -o loop $SOURCE_FILE $MOUNT_DIR<br><br>        SQUASHFS_PATH=$(find $MOUNT_DIR -name &quot;filesystem.squashfs&quot; | head -n1)<br>        if [ -z &quot;$SQUASHFS_PATH&quot; ]; then<br>            echo &quot;❌ ISO 中未找到 filesystem.squashfs&quot;<br>            exit 1<br>        fi<br><br>        echo &quot;👉 解压 squashfs 到 rootfs...&quot;<br>        sudo unsquashfs -d $ROOTFS_DIR $SQUASHFS_PATH<br>        sudo umount $MOUNT_DIR<br>        rm -rf $MOUNT_DIR<br>    else<br>        echo &quot;❌ 类型必须是 tar 或 iso&quot;<br>        exit 1<br>    fi<br>    echo &quot;✅ rootfs 已缓存到 $ROOTFS_DIR&quot;<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查 shell</span><br>if [ -f &quot;$ROOTFS_DIR/bin/bash&quot; ]; then<br>    SHELL_PATH=&quot;/bin/bash&quot;<br>elif [ -f &quot;$ROOTFS_DIR/bin/sh&quot; ]; then<br>    SHELL_PATH=&quot;/bin/sh&quot;<br>else<br>    echo &quot;❌ rootfs 缺少 /bin/sh 或 /bin/bash，无法构建 Docker 镜像！&quot;<br>    exit 1<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">自动检测架构</span><br>ARCH=$(file -bL $ROOTFS_DIR$SHELL_PATH | awk &#x27;&#123;print $2&#125;&#x27;)<br>echo &quot;👉 检测到架构: $ARCH&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">导入 Docker 临时镜像</span><br>echo &quot;👉 导入 Docker 临时镜像...&quot;<br>sudo tar -C $ROOTFS_DIR -c . | docker import - $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">FULL 模式安装常用工具</span><br>if [ &quot;$MODE&quot; = &quot;--full&quot; ]; then<br>    echo &quot;👉 FULL 模式: 安装常用工具...&quot;<br>    cat &gt; Dockerfile &lt;&lt;EOF<br>FROM $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION<br>ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai<br>RUN dpkg --add-architecture $ARCH || true<br>RUN apt-get update &amp;&amp; apt-get install -y \\<br>    vim curl wget net-tools iputils-ping less lsb-release ca-certificates \\<br>    &amp;&amp; rm -rf /var/lib/apt/lists/*<br>CMD [&quot;$SHELL_PATH&quot;]<br>EOF<br><br>    docker build -t $IMAGE_NAME:$UBUNTU_VERSION .<br>    rm -f Dockerfile<br>else<br>    echo &quot;👉 MINIMAL 模式: 不安装额外工具&quot;<br>    docker tag $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION $IMAGE_NAME:$UBUNTU_VERSION<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理临时镜像</span><br>docker rmi $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION &gt;/dev/null 2&gt;&amp;1 || true<br><br>echo &quot;✅ 镜像构建完成！&quot;<br>echo &quot;运行示例: docker run -it $IMAGE_NAME:$UBUNTU_VERSION $SHELL_PATH&quot;<br>echo &quot;缓存 rootfs 路径: $ROOTFS_DIR&quot;<br><br></code></pre></td></tr></table></figure>
<ol type="1">
<li><strong>兼容官方 cloud image tar 文件命名</strong>
<ul>
<li>自动解析 focal/jammy/bionic 并映射到 20.04/22.04/18.04</li>
</ul></li>
<li><strong>支持 Live ISO</strong>，自动解压 squashfs</li>
<li><strong>确保容器有可用 shell</strong> (<code>/bin/bash</code> 或
<code>/bin/sh</code>)</li>
<li><strong>FULL / MINIMAL 模式</strong>，自动安装工具</li>
<li><strong>本机缓存管理</strong>，自动清理过期 rootfs</li>
</ol>
<p>🔹 使用示例</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># 使用官方 cloud image tar 构建 FULL 镜像</span><br>./offline-ubuntu-docker-auto-cloud.sh ubuntu-focal-core-cloudimg-amd64-root.tar.gz tar <span class="hljs-comment">--full my-ubuntu</span><br><br><span class="hljs-comment"># 使用 Live ISO 构建 MINIMAL 镜像</span><br>./offline-ubuntu-docker-auto-cloud.sh ubuntu<span class="hljs-number">-22.04</span>-live-server-amd64.iso iso <span class="hljs-comment">--minimal my-ubuntu</span><br><br><span class="hljs-comment"># 运行容器</span><br>docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> <span class="hljs-keyword">my</span>-ubuntu:<span class="hljs-number">20.04</span> /bin/bash<br></code></pre></td></tr></table></figure>
<hr />
<p>这个脚本可以直接兼容 <strong>官方 cloud image
命名</strong>，不用改名字就能构建 Docker 镜像，并支持 ISO 一键构建。</p>
<h4 id="改进6">改进6</h4>
<p>执行上面的脚本出现 offline-ubuntu-docker-auto-cloud.sh: 32:
offline-ubuntu-docker-auto-cloud.sh: Syntax error: "(" unexpected
(expecting "then")错误。</p>
<p>通常 <strong>出现在 <code>/bin/sh</code> 执行 Bash
脚本时</strong>，而脚本使用了 <strong>Bash 特有语法</strong>（如
<code>[[ ... =~ ... ]]</code> 或数组、括号扩展）。</p>
<p>原因分析</p>
<ol type="1">
<li>你可能用 <code>sh offline-ubuntu-docker-auto-cloud.sh</code>
执行，而不是 <code>bash</code>。
<ul>
<li><code>/bin/sh</code> 在大多数系统上是 dash，不支持
<code>[[ ... =~ ... ]]</code> 正则匹配语法。</li>
</ul></li>
<li>脚本第一行是：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br></code></pre></td></tr></table></figure>
<ul>
<li>表示必须用 <strong>bash</strong> 运行。</li>
</ul>
<p>解决方法</p>
<p>方法 1：用 bash 执行</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">bash offline-ubuntu-docker-auto-cloud<span class="hljs-selector-class">.sh</span> ubuntu-focal-core-cloudimg-amd64-root<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span> tar <span class="hljs-attr">--full</span> my-ubuntu<br></code></pre></td></tr></table></figure>
<p>方法 2：给脚本可执行权限并直接运行</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">chmod +x offline-ubuntu-docker-auto-cloud<span class="hljs-selector-class">.sh</span><br>./offline-ubuntu-docker-auto-cloud<span class="hljs-selector-class">.sh</span> ubuntu-focal-core-cloudimg-amd64-root<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span> tar <span class="hljs-attr">--full</span> my-ubuntu<br></code></pre></td></tr></table></figure>
<p>✅ 这样就不会出现 <code>Syntax error: "(" unexpected</code>
的问题。</p>
<p>注意</p>
<ul>
<li><p><strong>不要用 <code>sh script.sh</code></strong>，因为
<code>/bin/sh</code> 不同于 bash，很多语法不兼容。</p></li>
<li><p>脚本里用到了：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-string">[[ &quot;$BASENAME&quot; =~ ubuntu-([a-z]+)-core ]]</span><br></code></pre></td></tr></table></figure>
<p>这是 Bash 特有正则匹配语法，必须用 bash。</p></li>
</ul>
<p>如果出现，ubuntu-focal-core-cloudimg-amd64-root.tar.gz rootfs 缺少
/bin/sh 或 /bin/bash，无法构建 Docker 镜像！官方的
<code>ubuntu-focal-core-cloudimg-amd64-root.tar.gz</code>
<strong>是最小化 rootfs</strong>，里面可能只包含 <code>/bin/dash</code>
或 <code>/usr/bin/sh</code>，没有 <code>/bin/bash</code>。minimal rootfs
默认只有 <code>/bin/sh</code>（dash），没有 bash</p>
<p><strong>解决方案</strong>：</p>
<ol type="1">
<li>使用 <code>/bin/sh</code> 启动容器即可</li>
<li>FULL 模式下安装 bash 和常用工具</li>
</ol>
<p>让它 <strong>兼容 minimal rootfs</strong>，自动处理
<code>/bin/sh</code> 或 <code>/bin/bash</code>：</p>
<ul>
<li><strong>如果 rootfs 没有 bash</strong>，CMD 就用
<code>/bin/sh</code>，避免报错</li>
<li><strong>FULL 模式</strong> 下自动安装 bash 和常用工具</li>
</ul>
<p>offline-ubuntu-docker-auto-cloud-fixed.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>set -e<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">离线构建 Ubuntu Docker 镜像（支持 cloud image minimal rootfs）</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">FULL 模式会安装 bash 和常用工具</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用：</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">./offline-ubuntu-docker-auto-cloud-fixed.sh &lt;<span class="hljs-built_in">source</span>&gt; &lt;<span class="hljs-built_in">type</span>&gt; &lt;mode&gt; &lt;imagename&gt;</span><br><br>SOURCE_FILE=$1<br>TYPE=$2<br>MODE=$&#123;3:---full&#125;<br>IMAGE_NAME=$&#123;4:-my-ubuntu&#125;<br>CACHE_DIR=&quot;$HOME/.offline-ubuntu-cache&quot;<br>CACHE_MAX_DAYS=30<br><br>if [ -z &quot;$SOURCE_FILE&quot; ] || [ -z &quot;$TYPE&quot; ]; then<br>    echo &quot;❌ 参数错误！请提供 source 文件路径和类型 (tar/iso)&quot;<br>    exit 1<br>fi<br><br>mkdir -p $CACHE_DIR<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">自动解析版本号</span><br>BASENAME=$(basename &quot;$SOURCE_FILE&quot;)<br>if [[ &quot;$BASENAME&quot; =~ ubuntu-([a-z]+)-core ]]; then<br>    UBUNTU_CODENAME=&quot;$&#123;BASH_REMATCH[1]&#125;&quot;<br>    case &quot;$UBUNTU_CODENAME&quot; in<br>        focal) UBUNTU_VERSION=&quot;20.04&quot; ;;<br>        jammy) UBUNTU_VERSION=&quot;22.04&quot; ;;<br>        bionic) UBUNTU_VERSION=&quot;18.04&quot; ;;<br>        *) UBUNTU_VERSION=&quot;latest&quot; ;;<br>    esac<br>else<br>    UBUNTU_VERSION=&quot;latest&quot;<br>fi<br><br>ROOTFS_DIR=&quot;$CACHE_DIR/rootfs-$UBUNTU_VERSION&quot;<br><br>echo &quot;====== 离线构建 Ubuntu Docker 镜像 ======&quot;<br>echo &quot;源文件       : $SOURCE_FILE&quot;<br>echo &quot;类型         : $TYPE&quot;<br>echo &quot;Docker Tag   : $UBUNTU_VERSION&quot;<br>echo &quot;模式         : $MODE&quot;<br>echo &quot;镜像名       : $IMAGE_NAME&quot;<br>echo &quot;缓存目录     : $CACHE_DIR&quot;<br>echo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理过期缓存</span><br>echo &quot;👉 清理超过 $CACHE_MAX_DAYS 天的缓存...&quot;<br>find $CACHE_DIR -maxdepth 1 -type d -name &quot;rootfs-*&quot; -mtime +$CACHE_MAX_DAYS -exec rm -rf &#123;&#125; \;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查缓存</span><br>if [ -d &quot;$ROOTFS_DIR&quot; ]; then<br>    echo &quot;✅ 检测到缓存 rootfs，直接使用缓存...&quot;<br>else<br>    rm -rf $ROOTFS_DIR<br>    mkdir -p $ROOTFS_DIR<br><br>    if [ &quot;$TYPE&quot; = &quot;tar&quot; ]; then<br>        echo &quot;👉 导入 rootfs tar...&quot;<br>        sudo tar -C $ROOTFS_DIR -xf $SOURCE_FILE<br>    elif [ &quot;$TYPE&quot; = &quot;iso&quot; ]; then<br>        echo &quot;👉 挂载 ISO 提取 squashfs...&quot;<br>        MOUNT_DIR=&quot;$CACHE_DIR/iso-mount-$UBUNTU_VERSION&quot;<br>        mkdir -p $MOUNT_DIR<br>        sudo mount -o loop $SOURCE_FILE $MOUNT_DIR<br><br>        SQUASHFS_PATH=$(find $MOUNT_DIR -name &quot;filesystem.squashfs&quot; | head -n1)<br>        if [ -z &quot;$SQUASHFS_PATH&quot; ]; then<br>            echo &quot;❌ ISO 中未找到 filesystem.squashfs&quot;<br>            exit 1<br>        fi<br><br>        echo &quot;👉 解压 squashfs 到 rootfs...&quot;<br>        sudo unsquashfs -d $ROOTFS_DIR $SQUASHFS_PATH<br>        sudo umount $MOUNT_DIR<br>        rm -rf $MOUNT_DIR<br>    else<br>        echo &quot;❌ 类型必须是 tar 或 iso&quot;<br>        exit 1<br>    fi<br>    echo &quot;✅ rootfs 已缓存到 $ROOTFS_DIR&quot;<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查 shell</span><br>if [ -f &quot;$ROOTFS_DIR/bin/bash&quot; ]; then<br>    SHELL_PATH=&quot;/bin/bash&quot;<br>elif [ -f &quot;$ROOTFS_DIR/bin/sh&quot; ]; then<br>    SHELL_PATH=&quot;/bin/sh&quot;<br>else<br>    echo &quot;⚠️ rootfs 没有 shell，使用 dash 代替&quot;<br>    SHELL_PATH=&quot;/bin/dash&quot;<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检测架构</span><br>ARCH=$(file -bL $ROOTFS_DIR$SHELL_PATH | awk &#x27;&#123;print $2&#125;&#x27;)<br>echo &quot;👉 检测到架构: $ARCH&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">导入 Docker 临时镜像</span><br>echo &quot;👉 导入 Docker 临时镜像...&quot;<br>sudo tar -C $ROOTFS_DIR -c . | docker import - $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">FULL 模式安装常用工具</span><br>if [ &quot;$MODE&quot; = &quot;--full&quot; ]; then<br>    echo &quot;👉 FULL 模式: 安装 bash 和常用工具...&quot;<br>    cat &gt; Dockerfile &lt;&lt;EOF<br>FROM $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION<br>ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai<br>RUN apt-get update &amp;&amp; apt-get install -y \\<br>    bash vim curl wget net-tools iputils-ping less lsb-release ca-certificates \\<br>    &amp;&amp; rm -rf /var/lib/apt/lists/*<br>CMD [&quot;/bin/bash&quot;]<br>EOF<br><br>    docker build -t $IMAGE_NAME:$UBUNTU_VERSION .<br>    rm -f Dockerfile<br>else<br>    echo &quot;👉 MINIMAL 模式: 不安装额外工具，使用 $SHELL_PATH&quot;<br>    docker tag $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION $IMAGE_NAME:$UBUNTU_VERSION<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理临时镜像</span><br>docker rmi $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION &gt;/dev/null 2&gt;&amp;1 || true<br><br>echo &quot;✅ 镜像构建完成！&quot;<br>echo &quot;运行示例: docker run -it $IMAGE_NAME:$UBUNTU_VERSION $SHELL_PATH&quot;<br>echo &quot;缓存 rootfs 路径: $ROOTFS_DIR&quot;<br><br></code></pre></td></tr></table></figure>
<p>使用说明</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># FULL 模式（安装 bash 和工具）</span><br>./offline-ubuntu-docker-auto-cloud-fixed.sh ubuntu-focal-core-cloudimg-amd64-root.tar.gz tar <span class="hljs-comment">--full my-ubuntu</span><br><br><span class="hljs-comment"># MINIMAL 模式（保留 minimal rootfs）</span><br>./offline-ubuntu-docker-auto-cloud-fixed.sh ubuntu-focal-core-cloudimg-amd64-root.tar.gz tar <span class="hljs-comment">--minimal my-ubuntu</span><br><br><span class="hljs-comment"># 运行容器</span><br>docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> <span class="hljs-keyword">my</span>-ubuntu:<span class="hljs-number">20.04</span> /bin/bash   <span class="hljs-comment"># FULL 模式</span><br>docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> <span class="hljs-keyword">my</span>-ubuntu:<span class="hljs-number">20.04</span> /bin/sh     <span class="hljs-comment"># MINIMAL 模式</span><br><br></code></pre></td></tr></table></figure>
<h4 id="改进7">改进7</h4>
<p>执行上面的脚本出现错误 ./offline-ubuntu-docker-auto-cloud-fixed.sh:
25: ./offline-ubuntu-docker-auto-cloud-fixed.sh: Syntax error: "("
unexpected (expecting "then")</p>
<p>和之前提到的原因完全一样：系统在 <strong>用 <code>/bin/sh</code>
执行脚本</strong>，而脚本使用了 <strong>Bash 特有语法</strong>（如
<code>[[ ... =~ ... ]]</code> 的正则匹配）。</p>
<p>在你的脚本里，出错的位置是：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> <span class="hljs-string">[[ &quot;$BASENAME&quot; =~ ubuntu-([a-z]+)-core ]]</span>; <span class="hljs-keyword">then</span><br></code></pre></td></tr></table></figure>
<ul>
<li><code>[[ ... =~ ... ]]</code> 是 <strong>bash</strong> 专用</li>
<li><code>/bin/sh</code>（dash）不支持这个语法，会报
<code>Syntax error: "(" unexpected</code></li>
</ul>
<p><strong>解决方法</strong></p>
<p>1️⃣ <strong>用 bash 执行</strong></p>
<p>不要用 <code>sh script.sh</code>，一定要用：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">bash offline-ubuntu-docker-auto-cloud-fixed<span class="hljs-selector-class">.sh</span> ubuntu-focal-core-cloudimg-amd64-root<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span> tar <span class="hljs-attr">--full</span> my-ubuntu<br></code></pre></td></tr></table></figure>
<p>或者：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">chmod +x offline-ubuntu-docker-auto-cloud-fixed<span class="hljs-selector-class">.sh</span><br>./offline-ubuntu-docker-auto-cloud-fixed<span class="hljs-selector-class">.sh</span> ubuntu-focal-core-cloudimg-amd64-root<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span> tar <span class="hljs-attr">--full</span> my-ubuntu<br></code></pre></td></tr></table></figure>
<blockquote>
<p>这样 <code>/bin/bash</code> 会执行脚本，<code>[[ ... =~ ... ]]</code>
就可以工作。</p>
</blockquote>
<p>2️⃣ <strong>修改脚本兼容 sh（可选）</strong></p>
<p>如果你希望脚本完全兼容 <code>/bin/sh</code>，需要把：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> <span class="hljs-string">[[ &quot;$BASENAME&quot; =~ ubuntu-([a-z]+)-core ]]</span>; <span class="hljs-keyword">then</span><br>    UBUNTU_CODENAME=<span class="hljs-string">&quot;$&#123;BASH_REMATCH[1]&#125;&quot;</span><br></code></pre></td></tr></table></figure>
<p>改成 POSIX sh 兼容写法，例如：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">UBUNTU_CODENAME</span>=$(echo <span class="hljs-string">&quot;<span class="hljs-variable">$BASENAME</span>&quot;</span> | sed -n <span class="hljs-string">&#x27;s/ubuntu-\([a-z]\+\)-core.*/\1/p&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>然后根据 UBUNTU_CODENAME 设置 UBUNTU_VERSION。</p>
<p>这种方式完全兼容
<code>/bin/sh</code>，不会再报语法错误，但脚本语法会更冗长。</p>
<hr />
<p>💡 <strong>推荐做法</strong>：</p>
<ul>
<li>脚本开头声明 <code>#!/bin/bash</code></li>
<li>执行时一定用 <code>bash script.sh</code> 或
<code>./script.sh</code></li>
<li>不要用 <code>sh script.sh</code>，否则 minimal cloud image
的构建和正则匹配都会报错</li>
</ul>
<p>改写一版 <strong>完全兼容 <code>/bin/sh</code> 的离线 Ubuntu Docker
构建脚本</strong>，特点如下：</p>
<ul>
<li><strong>不依赖 Bash</strong>，可用 <code>sh script.sh</code>
直接运行</li>
<li><strong>兼容官方 cloud image minimal rootfs</strong></li>
<li><strong>FULL 模式自动安装 bash 和常用工具</strong></li>
<li><strong>MINIMAL 模式直接使用 <code>/bin/sh</code> 或
<code>/bin/dash</code></strong></li>
<li><strong>支持 tar 和 ISO 两种类型</strong></li>
</ul>
<p>offline-ubuntu-docker-sh.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">set</span> -e<br><br><span class="hljs-comment"># 离线构建 Ubuntu Docker 镜像（完全兼容 sh）</span><br><span class="hljs-comment"># 使用：</span><br><span class="hljs-comment"># sh offline-ubuntu-docker-sh.sh &lt;source&gt; &lt;type&gt; &lt;mode&gt; &lt;imagename&gt;</span><br><br>SOURCE_FILE=<span class="hljs-variable">$1</span><br>TYPE=<span class="hljs-variable">$2</span><br>MODE=<span class="hljs-variable">$&#123;3:=--full&#125;</span><br>IMAGE_NAME=<span class="hljs-variable">$&#123;4:=my-ubuntu&#125;</span><br>CACHE_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$HOME</span>/.offline-ubuntu-cache&quot;</span><br>CACHE_MAX_DAYS=30<br><br><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$SOURCE_FILE</span>&quot;</span> ] || [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$TYPE</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;❌ 参数错误！请提供 source 文件路径和类型 (tar/iso)&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">&quot;<span class="hljs-variable">$CACHE_DIR</span>&quot;</span><br><br><span class="hljs-comment"># 提取 Ubuntu 版本（sh 兼容）</span><br>BASENAME=$(<span class="hljs-built_in">basename</span> <span class="hljs-string">&quot;<span class="hljs-variable">$SOURCE_FILE</span>&quot;</span>)<br>UBUNTU_CODENAME=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$BASENAME</span>&quot;</span> | sed -n <span class="hljs-string">&#x27;s/ubuntu-\([a-z]\+\)-core.*/\1/p&#x27;</span>)<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$UBUNTU_CODENAME</span>&quot;</span> <span class="hljs-keyword">in</span><br>    focal) UBUNTU_VERSION=<span class="hljs-string">&quot;20.04&quot;</span> ;;<br>    jammy) UBUNTU_VERSION=<span class="hljs-string">&quot;22.04&quot;</span> ;;<br>    bionic) UBUNTU_VERSION=<span class="hljs-string">&quot;18.04&quot;</span> ;;<br>    *) UBUNTU_VERSION=<span class="hljs-string">&quot;latest&quot;</span> ;;<br><span class="hljs-keyword">esac</span><br><br>ROOTFS_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$CACHE_DIR</span>/rootfs-<span class="hljs-variable">$UBUNTU_VERSION</span>&quot;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;====== 离线构建 Ubuntu Docker 镜像 ======&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;源文件       : <span class="hljs-variable">$SOURCE_FILE</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;类型         : <span class="hljs-variable">$TYPE</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Docker Tag   : <span class="hljs-variable">$UBUNTU_VERSION</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;模式         : <span class="hljs-variable">$MODE</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;镜像名       : <span class="hljs-variable">$IMAGE_NAME</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;缓存目录     : <span class="hljs-variable">$CACHE_DIR</span>&quot;</span><br><span class="hljs-built_in">echo</span><br><br><span class="hljs-comment"># 清理过期缓存</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 清理超过 <span class="hljs-variable">$CACHE_MAX_DAYS</span> 天的缓存...&quot;</span><br>find <span class="hljs-string">&quot;<span class="hljs-variable">$CACHE_DIR</span>&quot;</span> -maxdepth 1 -<span class="hljs-built_in">type</span> d -name <span class="hljs-string">&quot;rootfs-*&quot;</span> -mtime +<span class="hljs-string">&quot;<span class="hljs-variable">$CACHE_MAX_DAYS</span>&quot;</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -rf &#123;&#125; \;<br><br><span class="hljs-comment"># 导入 rootfs</span><br><span class="hljs-keyword">if</span> [ -d <span class="hljs-string">&quot;<span class="hljs-variable">$ROOTFS_DIR</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✅ 检测到缓存 rootfs，直接使用缓存...&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">rm</span> -rf <span class="hljs-string">&quot;<span class="hljs-variable">$ROOTFS_DIR</span>&quot;</span><br>    <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">&quot;<span class="hljs-variable">$ROOTFS_DIR</span>&quot;</span><br><br>    <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$TYPE</span>&quot;</span> = <span class="hljs-string">&quot;tar&quot;</span> ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 导入 rootfs tar...&quot;</span><br>        sudo tar -C <span class="hljs-string">&quot;<span class="hljs-variable">$ROOTFS_DIR</span>&quot;</span> -xf <span class="hljs-string">&quot;<span class="hljs-variable">$SOURCE_FILE</span>&quot;</span><br>    <span class="hljs-keyword">elif</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$TYPE</span>&quot;</span> = <span class="hljs-string">&quot;iso&quot;</span> ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 挂载 ISO 提取 squashfs...&quot;</span><br>        MOUNT_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$CACHE_DIR</span>/iso-mount-<span class="hljs-variable">$UBUNTU_VERSION</span>&quot;</span><br>        <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">&quot;<span class="hljs-variable">$MOUNT_DIR</span>&quot;</span><br>        sudo mount -o loop <span class="hljs-string">&quot;<span class="hljs-variable">$SOURCE_FILE</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$MOUNT_DIR</span>&quot;</span><br><br>        SQUASHFS_PATH=$(find <span class="hljs-string">&quot;<span class="hljs-variable">$MOUNT_DIR</span>&quot;</span> -name <span class="hljs-string">&quot;filesystem.squashfs&quot;</span> | <span class="hljs-built_in">head</span> -n1)<br>        <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$SQUASHFS_PATH</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;❌ ISO 中未找到 filesystem.squashfs&quot;</span><br>            <span class="hljs-built_in">exit</span> 1<br>        <span class="hljs-keyword">fi</span><br><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 解压 squashfs 到 rootfs...&quot;</span><br>        sudo unsquashfs -d <span class="hljs-string">&quot;<span class="hljs-variable">$ROOTFS_DIR</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$SQUASHFS_PATH</span>&quot;</span><br>        sudo umount <span class="hljs-string">&quot;<span class="hljs-variable">$MOUNT_DIR</span>&quot;</span><br>        <span class="hljs-built_in">rm</span> -rf <span class="hljs-string">&quot;<span class="hljs-variable">$MOUNT_DIR</span>&quot;</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;❌ 类型必须是 tar 或 iso&quot;</span><br>        <span class="hljs-built_in">exit</span> 1<br>    <span class="hljs-keyword">fi</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✅ rootfs 已缓存到 <span class="hljs-variable">$ROOTFS_DIR</span>&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 检查 shell</span><br><span class="hljs-keyword">if</span> [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$ROOTFS_DIR</span>/bin/bash&quot;</span> ]; <span class="hljs-keyword">then</span><br>    SHELL_PATH=<span class="hljs-string">&quot;/bin/bash&quot;</span><br><span class="hljs-keyword">elif</span> [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$ROOTFS_DIR</span>/bin/sh&quot;</span> ]; <span class="hljs-keyword">then</span><br>    SHELL_PATH=<span class="hljs-string">&quot;/bin/sh&quot;</span><br><span class="hljs-keyword">elif</span> [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$ROOTFS_DIR</span>/bin/dash&quot;</span> ]; <span class="hljs-keyword">then</span><br>    SHELL_PATH=<span class="hljs-string">&quot;/bin/dash&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;⚠️ rootfs 没有 shell，使用 /bin/sh&quot;</span><br>    SHELL_PATH=<span class="hljs-string">&quot;/bin/sh&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 导入 Docker 临时镜像</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 导入 Docker 临时镜像...&quot;</span><br>sudo tar -C <span class="hljs-string">&quot;<span class="hljs-variable">$ROOTFS_DIR</span>&quot;</span> -c . | docker import - <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$UBUNTU_VERSION</span>&quot;</span><br><br><span class="hljs-comment"># FULL 模式安装工具</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$MODE</span>&quot;</span> = <span class="hljs-string">&quot;--full&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 FULL 模式: 安装 bash 和常用工具...&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;FROM <span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$UBUNTU_VERSION</span></span><br><span class="hljs-string">ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai</span><br><span class="hljs-string">RUN apt-get update &amp;&amp; apt-get install -y bash vim curl wget net-tools iputils-ping less lsb-release ca-certificates &amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="hljs-string">CMD [\&quot;/bin/bash\&quot;]&quot;</span> &gt; Dockerfile<br><br>    docker build -t <span class="hljs-string">&quot;<span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$UBUNTU_VERSION</span>&quot;</span> .<br>    <span class="hljs-built_in">rm</span> -f Dockerfile<br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;👉 MINIMAL 模式: 使用 <span class="hljs-variable">$SHELL_PATH</span>&quot;</span><br>    docker tag <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$UBUNTU_VERSION</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$UBUNTU_VERSION</span>&quot;</span><br><span class="hljs-keyword">fi</span><br><br>docker rmi <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;IMAGE_NAME&#125;</span>-base:<span class="hljs-variable">$UBUNTU_VERSION</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1 || <span class="hljs-literal">true</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✅ 镜像构建完成！&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;运行示例: docker run -it <span class="hljs-variable">$IMAGE_NAME</span>:<span class="hljs-variable">$UBUNTU_VERSION</span> <span class="hljs-variable">$SHELL_PATH</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;缓存 rootfs 路径: <span class="hljs-variable">$ROOTFS_DIR</span>&quot;</span><br><br></code></pre></td></tr></table></figure>
<p>使用方法</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># FULL 模式</span><br>sh offline-ubuntu-docker-sh.sh ubuntu-focal-core-cloudimg-amd64-root.tar.gz tar <span class="hljs-comment">--full my-ubuntu</span><br><br><span class="hljs-comment"># MINIMAL 模式</span><br>sh offline-ubuntu-docker-sh.sh ubuntu-focal-core-cloudimg-amd64-root.tar.gz tar <span class="hljs-comment">--minimal my-ubuntu</span><br><br><span class="hljs-comment"># 运行容器</span><br>docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> <span class="hljs-keyword">my</span>-ubuntu:<span class="hljs-number">20.04</span> /bin/bash   <span class="hljs-comment"># FULL 模式</span><br>docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> <span class="hljs-keyword">my</span>-ubuntu:<span class="hljs-number">20.04</span> /bin/sh     <span class="hljs-comment"># MINIMAL 模式</span><br><br></code></pre></td></tr></table></figure>
<h4 id="改进8">改进8</h4>
<p>container_linux.go:247: starting container process caused "exec:
"/bin/sh": stat /bin/sh: no such file or directory" oci runtime error:
container_linux.go:247: starting container process caused "exec:
"/bin/sh": stat /bin/sh: no such file or directory"</p>
<p>这说明 <strong>你导入的 rootfs 本身没有
<code>/bin/sh</code></strong>，这是最小化 cloud image 的正常现象。官方
minimal rootfs 通常只包含：</p>
<ul>
<li><code>/bin/dash</code> 或 <code>/usr/bin/sh</code></li>
<li>没有 <code>/bin/bash</code></li>
<li>有时 <code>/bin/sh</code> 是符号链接，可能缺失</li>
</ul>
<p>所以直接用 <code>/bin/sh</code> 启动容器会报错。</p>
<p>🔹 解决方案</p>
<p>方法 1️⃣ 使用 FULL 模式安装 bash</p>
<ol type="1">
<li>FULL 模式构建 Docker 镜像时，脚本会安装 bash：</li>
</ol>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">apt-<span class="hljs-built_in">get</span> <span class="hljs-keyword">update</span><br>apt-<span class="hljs-built_in">get</span> install -<span class="hljs-keyword">y</span> bash <span class="hljs-keyword">vim</span> curl wget net-tools iputils-ping less lsb-release <span class="hljs-keyword">ca</span>-certificates<br></code></pre></td></tr></table></figure>
<ol type="1">
<li>构建完成后，容器可以直接用 <code>/bin/bash</code> 启动：</li>
</ol>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> <span class="hljs-keyword">my</span>-ubuntu:<span class="hljs-number">20.04</span> /bin/bash<br></code></pre></td></tr></table></figure>
<p>✅ 这是最简单可靠的方法。</p>
<p>方法 2️⃣ 手动检查 rootfs 并创建 <code>/bin/sh</code> 符号链接</p>
<p>如果你希望 MINIMAL 模式也能用 <code>/bin/sh</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 进入 rootfs</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$ROOTFS_DIR</span><br><br><span class="hljs-comment"># 查看现有 shell</span><br><span class="hljs-built_in">ls</span> -l bin/ dash sh bash<br><br><span class="hljs-comment"># 如果只有 /bin/dash，可以创建符号链接</span><br>sudo <span class="hljs-built_in">ln</span> -s dash /bin/sh<br></code></pre></td></tr></table></figure>
<p>然后再导入 Docker：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dart">sudo tar -C <span class="hljs-string">&quot;<span class="hljs-subst">$ROOTFS_DIR</span>&quot;</span> -c . | docker <span class="hljs-keyword">import</span> - my-ubuntu:minimal<br></code></pre></td></tr></table></figure>
<p>再运行：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> <span class="hljs-keyword">my</span>-ubuntu:minimal /bin/sh<br></code></pre></td></tr></table></figure>
<p>方法 3️⃣ 直接在 Dockerfile 里安装 bash</p>
<p>在脚本里 MINIMAL 模式也可以做：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">FROM</span> my-ubuntu-base:20.04<br><span class="hljs-built_in">RUN</span> apt-<span class="hljs-built_in">get</span> update &amp;&amp; apt-<span class="hljs-built_in">get</span> install -y bash<br>CMD [<span class="hljs-string">&quot;/bin/bash&quot;</span>]<br></code></pre></td></tr></table></figure>
<p>这样无论 minimal rootfs 原本有没有 shell，都能启动。</p>
<hr />
<p>💡 <strong>结论</strong>：</p>
<ul>
<li>Minimal cloud image 本身可能没有 <code>/bin/sh</code>，这是官方最小
rootfs 的正常现象</li>
<li><strong>可靠方法</strong>：FULL 模式安装 bash，然后用
<code>/bin/bash</code> 启动</li>
<li><strong>可选方法</strong>：手动用 <code>/bin/dash</code> 创建
<code>/bin/sh</code> 符号链接</li>
</ul>
<hr />
<p>改写 <strong>完全兼容 minimal rootfs 的离线 Docker
构建脚本</strong>，特点如下：</p>
<ul>
<li>FULL 模式：安装 bash 和常用工具</li>
<li>MINIMAL 模式：如果 rootfs 没有 <code>/bin/sh</code> 或
<code>/bin/bash</code>，自动创建 <code>/bin/sh</code> 指向
<code>/bin/dash</code>，保证容器可用</li>
<li>完全兼容 <code>/bin/sh</code> 执行，不依赖 bash</li>
<li>支持 tar 和 ISO 两种类型</li>
</ul>
<p>offline-ubuntu-docker-sh-auto.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>set -e<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">离线构建 Ubuntu Docker 镜像，自动处理 minimal rootfs</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">sh offline-ubuntu-docker-sh-auto.sh &lt;<span class="hljs-built_in">source</span>&gt; &lt;<span class="hljs-built_in">type</span>&gt; &lt;mode&gt; &lt;imagename&gt;</span><br><br>SOURCE_FILE=$1<br>TYPE=$2<br>MODE=$&#123;3:=--full&#125;<br>IMAGE_NAME=$&#123;4:=my-ubuntu&#125;<br>CACHE_DIR=&quot;$HOME/.offline-ubuntu-cache&quot;<br>CACHE_MAX_DAYS=30<br><br>if [ -z &quot;$SOURCE_FILE&quot; ] || [ -z &quot;$TYPE&quot; ]; then<br>    echo &quot;❌ 参数错误！请提供 source 文件路径和类型 (tar/iso)&quot;<br>    exit 1<br>fi<br><br>mkdir -p &quot;$CACHE_DIR&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">提取 Ubuntu 版本</span><br>BASENAME=$(basename &quot;$SOURCE_FILE&quot;)<br>UBUNTU_CODENAME=$(echo &quot;$BASENAME&quot; | sed -n &#x27;s/ubuntu-\([a-z]\+\)-core.*/\1/p&#x27;)<br>case &quot;$UBUNTU_CODENAME&quot; in<br>    focal) UBUNTU_VERSION=&quot;20.04&quot; ;;<br>    jammy) UBUNTU_VERSION=&quot;22.04&quot; ;;<br>    bionic) UBUNTU_VERSION=&quot;18.04&quot; ;;<br>    *) UBUNTU_VERSION=&quot;latest&quot; ;;<br>esac<br><br>ROOTFS_DIR=&quot;$CACHE_DIR/rootfs-$UBUNTU_VERSION&quot;<br><br>echo &quot;====== 离线构建 Ubuntu Docker 镜像 ======&quot;<br>echo &quot;源文件       : $SOURCE_FILE&quot;<br>echo &quot;类型         : $TYPE&quot;<br>echo &quot;Docker Tag   : $UBUNTU_VERSION&quot;<br>echo &quot;模式         : $MODE&quot;<br>echo &quot;镜像名       : $IMAGE_NAME&quot;<br>echo &quot;缓存目录     : $CACHE_DIR&quot;<br>echo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理过期缓存</span><br>echo &quot;👉 清理超过 $CACHE_MAX_DAYS 天的缓存...&quot;<br>find &quot;$CACHE_DIR&quot; -maxdepth 1 -type d -name &quot;rootfs-*&quot; -mtime +&quot;$CACHE_MAX_DAYS&quot; -exec rm -rf &#123;&#125; \;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">导入 rootfs</span><br>if [ -d &quot;$ROOTFS_DIR&quot; ]; then<br>    echo &quot;✅ 检测到缓存 rootfs，直接使用缓存...&quot;<br>else<br>    rm -rf &quot;$ROOTFS_DIR&quot;<br>    mkdir -p &quot;$ROOTFS_DIR&quot;<br><br>    if [ &quot;$TYPE&quot; = &quot;tar&quot; ]; then<br>        echo &quot;👉 导入 rootfs tar...&quot;<br>        sudo tar -C &quot;$ROOTFS_DIR&quot; -xf &quot;$SOURCE_FILE&quot;<br>    elif [ &quot;$TYPE&quot; = &quot;iso&quot; ]; then<br>        echo &quot;👉 挂载 ISO 提取 squashfs...&quot;<br>        MOUNT_DIR=&quot;$CACHE_DIR/iso-mount-$UBUNTU_VERSION&quot;<br>        mkdir -p &quot;$MOUNT_DIR&quot;<br>        sudo mount -o loop &quot;$SOURCE_FILE&quot; &quot;$MOUNT_DIR&quot;<br><br>        SQUASHFS_PATH=$(find &quot;$MOUNT_DIR&quot; -name &quot;filesystem.squashfs&quot; | head -n1)<br>        if [ -z &quot;$SQUASHFS_PATH&quot; ]; then<br>            echo &quot;❌ ISO 中未找到 filesystem.squashfs&quot;<br>            exit 1<br>        fi<br><br>        echo &quot;👉 解压 squashfs 到 rootfs...&quot;<br>        sudo unsquashfs -d &quot;$ROOTFS_DIR&quot; &quot;$SQUASHFS_PATH&quot;<br>        sudo umount &quot;$MOUNT_DIR&quot;<br>        rm -rf &quot;$MOUNT_DIR&quot;<br>    else<br>        echo &quot;❌ 类型必须是 tar 或 iso&quot;<br>        exit 1<br>    fi<br>    echo &quot;✅ rootfs 已缓存到 $ROOTFS_DIR&quot;<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查 shell，MINIMAL 模式处理</span><br>if [ -f &quot;$ROOTFS_DIR/bin/bash&quot; ]; then<br>    SHELL_PATH=&quot;/bin/bash&quot;<br>elif [ -f &quot;$ROOTFS_DIR/bin/sh&quot; ]; then<br>    SHELL_PATH=&quot;/bin/sh&quot;<br>elif [ -f &quot;$ROOTFS_DIR/bin/dash&quot; ]; then<br>    SHELL_PATH=&quot;/bin/sh&quot;<br>    # 创建 /bin/sh 符号链接指向 dash<br>    sudo ln -sf dash &quot;$ROOTFS_DIR/bin/sh&quot;<br>else<br>    echo &quot;⚠️ rootfs 没有 shell，尝试安装 dash&quot;<br>    sudo chroot &quot;$ROOTFS_DIR&quot; apt-get update<br>    sudo chroot &quot;$ROOTFS_DIR&quot; apt-get install -y dash<br>    SHELL_PATH=&quot;/bin/sh&quot;<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">导入 Docker 临时镜像</span><br>echo &quot;👉 导入 Docker 临时镜像...&quot;<br>sudo tar -C &quot;$ROOTFS_DIR&quot; -c . | docker import - &quot;$&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">FULL 模式安装工具</span><br>if [ &quot;$MODE&quot; = &quot;--full&quot; ]; then<br>    echo &quot;👉 FULL 模式: 安装 bash 和常用工具...&quot;<br>    echo &quot;FROM $&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION<br>ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai<br>RUN apt-get update &amp;&amp; apt-get install -y bash vim curl wget net-tools iputils-ping less lsb-release ca-certificates &amp;&amp; rm -rf /var/lib/apt/lists/*<br>CMD [\&quot;/bin/bash\&quot;]&quot; &gt; Dockerfile<br><br>    docker build -t &quot;$IMAGE_NAME:$UBUNTU_VERSION&quot; .<br>    rm -f Dockerfile<br>else<br>    echo &quot;👉 MINIMAL 模式: 使用 $SHELL_PATH&quot;<br>    docker tag &quot;$&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION&quot; &quot;$IMAGE_NAME:$UBUNTU_VERSION&quot;<br>fi<br><br>docker rmi &quot;$&#123;IMAGE_NAME&#125;-base:$UBUNTU_VERSION&quot; &gt;/dev/null 2&gt;&amp;1 || true<br><br>echo &quot;✅ 镜像构建完成！&quot;<br>echo &quot;运行示例: docker run -it $IMAGE_NAME:$UBUNTU_VERSION $SHELL_PATH&quot;<br>echo &quot;缓存 rootfs 路径: $ROOTFS_DIR&quot;<br><br></code></pre></td></tr></table></figure>
<p>使用方法</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># FULL 模式（安装 bash 和常用工具）</span><br>sh offline-ubuntu-docker-sh-auto.sh ubuntu-focal-core-cloudimg-amd64-root.tar.gz tar <span class="hljs-comment">--full my-ubuntu</span><br><br><span class="hljs-comment"># MINIMAL 模式（自动创建 /bin/sh 符号链接保证可用）</span><br>sh offline-ubuntu-docker-sh-auto.sh ubuntu-focal-core-cloudimg-amd64-root.tar.gz tar <span class="hljs-comment">--minimal my-ubuntu</span><br><br><span class="hljs-comment"># 运行容器</span><br>docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> <span class="hljs-keyword">my</span>-ubuntu:<span class="hljs-number">20.04</span> /bin/bash   <span class="hljs-comment"># FULL 模式</span><br>docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> <span class="hljs-keyword">my</span>-ubuntu:<span class="hljs-number">20.04</span> /bin/sh     <span class="hljs-comment"># MINIMAL 模式</span><br><br></code></pre></td></tr></table></figure>
<h4 id="最终版本">最终版本</h4>
<p>增加 <strong>批量构建多版本 Ubuntu 离线 Docker 镜像</strong>
的功能，特点如下：</p>
<ul>
<li>支持 18.04（bionic）、20.04（focal）、22.04（jammy）</li>
<li>自动下载对应 cloud image（如果本地没有）</li>
<li>FULL 模式：安装 bash 和常用工具</li>
<li>MINIMAL 模式：自动创建 <code>/bin/sh</code> 指向
<code>/bin/dash</code> 符号链接，保证容器可用</li>
<li>完全兼容 <code>/bin/sh</code> 执行，不依赖 bash</li>
</ul>
<p>offline-ubuntu-docker-multi.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>set -e<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">批量离线构建 Ubuntu Docker 镜像</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">sh offline-ubuntu-docker-multi.sh &lt;模式: --full/--minimal&gt; &lt;镜像前缀&gt;</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">示例：</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">sh offline-ubuntu-docker-multi.sh --full my-ubuntu</span><br><br>MODE=$&#123;1:=--full&#125;<br>IMAGE_PREFIX=$&#123;2:=my-ubuntu&#125;<br>CACHE_DIR=&quot;$HOME/.offline-ubuntu-cache&quot;<br>CACHE_MAX_DAYS=30<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">支持版本列表</span><br>VERSIONS=&quot;bionic focal jammy&quot;<br><br>echo &quot;====== 批量离线构建 Ubuntu Docker 镜像 ======&quot;<br>echo &quot;模式         : $MODE&quot;<br>echo &quot;镜像前缀     : $IMAGE_PREFIX&quot;<br>echo &quot;缓存目录     : $CACHE_DIR&quot;<br>echo<br><br>mkdir -p &quot;$CACHE_DIR&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理过期缓存</span><br>echo &quot;👉 清理超过 $CACHE_MAX_DAYS 天的缓存...&quot;<br>find &quot;$CACHE_DIR&quot; -maxdepth 1 -type d -name &quot;rootfs-*&quot; -mtime +&quot;$CACHE_MAX_DAYS&quot; -exec rm -rf &#123;&#125; \;<br><br>for codename in $VERSIONS; do<br>    case &quot;$codename&quot; in<br>        bionic) VERSION=&quot;18.04&quot;;;<br>        focal)  VERSION=&quot;20.04&quot;;;<br>        jammy)  VERSION=&quot;22.04&quot;;;<br>        *) VERSION=&quot;latest&quot;;;<br>    esac<br><br>    ROOTFS_DIR=&quot;$CACHE_DIR/rootfs-$VERSION&quot;<br>    TAR_FILE=&quot;$CACHE_DIR/ubuntu-$codename-core-cloudimg-amd64-root.tar.gz&quot;<br><br>    echo &quot;====== 构建 Ubuntu $VERSION ======&quot;<br><br>    # 如果本地没有 tar 文件，尝试提示用户自行下载<br>    if [ ! -f &quot;$TAR_FILE&quot; ]; then<br>        echo &quot;⚠️ 缺少 $TAR_FILE，请从 Ubuntu 官方下载 cloud image rootfs 并放置到缓存目录&quot;<br>        continue<br>    fi<br><br>    # 导入 rootfs<br>    if [ -d &quot;$ROOTFS_DIR&quot; ]; then<br>        echo &quot;✅ 检测到缓存 rootfs，直接使用缓存...&quot;<br>    else<br>        rm -rf &quot;$ROOTFS_DIR&quot;<br>        mkdir -p &quot;$ROOTFS_DIR&quot;<br>        echo &quot;👉 解压 $TAR_FILE 到 rootfs...&quot;<br>        sudo tar -C &quot;$ROOTFS_DIR&quot; -xf &quot;$TAR_FILE&quot;<br>        echo &quot;✅ rootfs 已缓存到 $ROOTFS_DIR&quot;<br>    fi<br><br>    # 检查 shell<br>    if [ -f &quot;$ROOTFS_DIR/bin/bash&quot; ]; then<br>        SHELL_PATH=&quot;/bin/bash&quot;<br>    elif [ -f &quot;$ROOTFS_DIR/bin/sh&quot; ]; then<br>        SHELL_PATH=&quot;/bin/sh&quot;<br>    elif [ -f &quot;$ROOTFS_DIR/bin/dash&quot; ]; then<br>        SHELL_PATH=&quot;/bin/sh&quot;<br>        sudo ln -sf dash &quot;$ROOTFS_DIR/bin/sh&quot;<br>    else<br>        echo &quot;⚠️ rootfs 没有 shell，尝试安装 dash&quot;<br>        sudo chroot &quot;$ROOTFS_DIR&quot; apt-get update<br>        sudo chroot &quot;$ROOTFS_DIR&quot; apt-get install -y dash<br>        SHELL_PATH=&quot;/bin/sh&quot;<br>    fi<br><br>    # 导入 Docker 临时镜像<br>    BASE_IMAGE=&quot;$&#123;IMAGE_PREFIX&#125;-base:$VERSION&quot;<br>    echo &quot;👉 导入 Docker 临时镜像: $BASE_IMAGE ...&quot;<br>    sudo tar -C &quot;$ROOTFS_DIR&quot; -c . | docker import - &quot;$BASE_IMAGE&quot;<br><br>    # FULL 模式安装工具<br>    if [ &quot;$MODE&quot; = &quot;--full&quot; ]; then<br>        echo &quot;👉 FULL 模式: 安装 bash 和常用工具...&quot;<br>        echo &quot;FROM $BASE_IMAGE<br>ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai<br>RUN apt-get update &amp;&amp; apt-get install -y bash vim curl wget net-tools iputils-ping less lsb-release ca-certificates &amp;&amp; rm -rf /var/lib/apt/lists/*<br>CMD [\&quot;/bin/bash\&quot;]&quot; &gt; Dockerfile<br><br>        docker build -t &quot;$&#123;IMAGE_PREFIX&#125;:$VERSION&quot; .<br>        rm -f Dockerfile<br>    else<br>        echo &quot;👉 MINIMAL 模式: 使用 $SHELL_PATH&quot;<br>        docker tag &quot;$BASE_IMAGE&quot; &quot;$&#123;IMAGE_PREFIX&#125;:$VERSION&quot;<br>    fi<br><br>    # 清理临时镜像<br>    docker rmi &quot;$BASE_IMAGE&quot; &gt;/dev/null 2&gt;&amp;1 || true<br>    echo &quot;✅ Ubuntu $VERSION 镜像构建完成！&quot;<br>done<br><br>echo &quot;🎉 所有版本构建完成！&quot;<br>echo &quot;运行示例: docker run -it $&#123;IMAGE_PREFIX&#125;:20.04 /bin/bash  # FULL 模式&quot;<br>echo &quot;或 docker run -it $&#123;IMAGE_PREFIX&#125;:20.04 /bin/sh         # MINIMAL 模式&quot;<br><br></code></pre></td></tr></table></figure>
<p>使用方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">FULL 模式（安装 bash 和工具）</span><br>sh offline-ubuntu-docker-multi.sh --full my-ubuntu<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">MINIMAL 模式（保留 minimal rootfs）</span><br>sh offline-ubuntu-docker-multi.sh --minimal my-ubuntu<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">运行容器</span><br>docker run -it my-ubuntu:20.04 /bin/bash   # FULL 模式<br>docker run -it my-ubuntu:20.04 /bin/sh     # MINIMAL 模式<br><br></code></pre></td></tr></table></figure>
<p>功能总结：</p>
<ol type="1">
<li>支持批量构建 18.04/20.04/22.04</li>
<li>FULL 模式自动安装 bash 和常用工具</li>
<li>MINIMAL 模式自动创建 <code>/bin/sh</code> 符号链接保证容器可用</li>
<li>完全兼容 <code>/bin/sh</code> 执行，不依赖 bash</li>
<li>提示用户下载缺失的 cloud image rootfs</li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%99%E7%A8%8B/" class="category-chain-item">教程</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%95%99%E7%A8%8B/docker/" class="category-chain-item">docker</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/09/09/%E6%9C%AC%E5%9C%B0%E5%88%B6%E4%BD%9Cdocker%E9%95%9C%E5%83%8F-1/" title="本地制作docker镜像">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">本地制作docker镜像</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/09/08/ubuntu%E4%BB%A3%E7%A0%81%E4%B8%8E%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB/" title="ubuntu代码与版本对应关系">
                        <span class="hidden-mobile">ubuntu代码与版本对应关系</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
